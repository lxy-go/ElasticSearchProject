# ElasticSearch搜房项目

# 1、需求分析

## 1、项目背景

- 租房：

  线下繁琐

  线上方便，

- 目标用户：

  一线城市，打工白领

- 项目可行性：

  人口流动趋势，和房源紧张，越早越快捷的找到合适的房屋租赁，可以减少人们浪费的人力和财力

## 2、数据库设计

> 做形式的外键关联，防止数据量大导致的，分库分表的约束

### 1、基础表

数据聚合

# 2、安装ElasticSearch

## 1、安装java环境

这里使用yum方式安装，前提是必须有网络

```shell
yum install java-1.8.0-openjdk
```

安装完成，查看java版本

```shell
[root@localhost ~]# java -version 
openjdk version "1.8.0_151"
OpenJDK Runtime Environment (build 1.8.0_151-b12)
OpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)
```

## 2、安装 Elasticsearch

Elasticsearch的安装很简单，下载下来解压即可，这里使用wget下载，当然也可通过网页下载 [https://www.elastic.co/downlo...](https://www.elastic.co/downloads/elasticsearch) ，再拷贝。

```
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.3.tar.gz
```

解压到/usr/local/

```
tar -zxvf elasticsearch-5.6.3.tar.gz -C /usr/local/
```

## 3、运行Elasticsearch

1.先以root用户新建并执行脚本，脚本配置如下

```shell
#!/bin/bash 
echo "* soft nofile 65536" >> /etc/security/limits.conf 
echo "* hard nofile 65536" >> /etc/security/limits.conf 
echo "* soft memlock unlimited" >> /etc/security/limits.conf 
echo "* hard memlock unlimited" >> /etc/security/limits.conf 
echo "vm.max_map_count = 262144" >> /etc/sysctl.conf 
sysctl -p 
ulimit -l unlimited
```



2、Elasticsearch 要求不能使用超级用户root运行，所以我们建立一个testuser账号

```
# 创建testuser账户
adduser testuser
# 修改密码
passwd testuser
```

3、然后，给testuser用户elasticsearch目录的授权。

```
chown -R testuser /usr/local/elasticsearch-5.6.3/
```

4、切换至elasticsearch目录，并以testuser用户运行

```
cd /usr/local/elasticsearch-5.6.3/
su testuser
```

5、运行elasticsearch，如果想后台运行后面加 -d

```
[testuser@localhost elasticsearch-5.6.3]$ ./bin/elasticsearch
[2017-10-31T16:07:09,445][INFO ][o.e.n.Node               ] [] initializing ...
[2017-10-31T16:07:09,662][INFO ][o.e.e.NodeEnvironment    ] [oDFU6c3] using [1] data paths, mounts [[/ (rootfs)]], net usable_space [45.4gb], net total_space [49.9gb], spins? [unknown], types [rootfs]
[2017-10-31T16:07:09,662][INFO ][o.e.e.NodeEnvironment    ] [oDFU6c3] heap size [1.9gb], compressed ordinary object pointers [true]
[2017-10-31T16:07:09,663][INFO ][o.e.n.Node               ] node name [oDFU6c3] derived from node ID [oDFU6c3UT6ORC2p0CKBeLA]; set [node.name] to override
[2017-10-31T16:07:09,663][INFO ][o.e.n.Node               ] version[5.6.3], pid[11484], build[1a2f265/2017-10-06T20:33:39.012Z], OS[Linux/3.10.0-514.26.2.el7.x86_64/amd64], JVM[Oracle Corporation/OpenJDK 64-Bit Server VM/1.8.0_151/25.151-b12]
[2017-10-31T16:07:09,664][INFO ][o.e.n.Node               ] JVM arguments [-Xms2g, -Xmx2g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -Djdk.io.permissionsUseCanonicalPath=true, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Dlog4j.skipJansi=true, -XX:+HeapDumpOnOutOfMemoryError, -Des.path.home=/usr/local/elasticsearch-5.6.3]
[2017-10-31T16:07:10,723][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [aggs-matrix-stats]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [ingest-common]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [lang-expression]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [lang-groovy]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [lang-mustache]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [lang-painless]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [parent-join]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [percolator]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [reindex]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [transport-netty3]
[2017-10-31T16:07:10,724][INFO ][o.e.p.PluginsService     ] [oDFU6c3] loaded module [transport-netty4]
[2017-10-31T16:07:10,725][INFO ][o.e.p.PluginsService     ] [oDFU6c3] no plugins loaded
[2017-10-31T16:07:12,622][INFO ][o.e.d.DiscoveryModule    ] [oDFU6c3] using discovery type [zen]
[2017-10-31T16:07:13,133][INFO ][o.e.n.Node               ] initialized
[2017-10-31T16:07:13,133][INFO ][o.e.n.Node               ] [oDFU6c3] starting ...
[2017-10-31T16:07:13,306][INFO ][o.e.t.TransportService   ] [oDFU6c3] publish_address {127.0.0.1:9300}, bound_addresses {[::1]:9300}, {127.0.0.1:9300}
[2017-10-31T16:07:13,318][WARN ][o.e.b.BootstrapChecks    ] [oDFU6c3] max file descriptors [65535] for elasticsearch process is too low, increase to at least [65536]
[2017-10-31T16:07:16,372][INFO ][o.e.c.s.ClusterService   ] [oDFU6c3] new_master {oDFU6c3}{oDFU6c3UT6ORC2p0CKBeLA}{olaY-n5LTpCUpzrhU3joVw}{127.0.0.1}{127.0.0.1:9300}, reason: zen-disco-elected-as-master ([0] nodes joined)
[2017-10-31T16:07:16,398][INFO ][o.e.h.n.Netty4HttpServerTransport] [oDFU6c3] publish_address {127.0.0.1:9200}, bound_addresses {[::1]:9200}, {127.0.0.1:9200}
[2017-10-31T16:07:16,399][INFO ][o.e.n.Node               ] [oDFU6c3] started
[2017-10-31T16:07:17,242][INFO ][o.e.g.GatewayService     ] [oDFU6c3] recovered [0] indices into cluster_state
```



6、如果没有没有error，就运行成功啦

新开一个终端，用curl访问

```
[root@localhost ~]# curl 'http://localhost:9200/?pretty' 
{
  "name" : "oDFU6c3",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "v2mGsAuuTsqIzzm8CZcW5w",
  "version" : {
    "number" : "5.6.3",
    "build_hash" : "1a2f265",
    "build_date" : "2017-10-06T20:33:39.012Z",
    "build_snapshot" : false,
    "lucene_version" : "6.6.1"
  },
  "tagline" : "You Know, for Search"
}
```

## 其他配置

elasticsearch指定ip地址

编辑es的配置文件

```
[testuser@localhost elasticsearch-5.6.3]$ vim ./config/elasticsearch.yml
```

找到network.host: 一行，去除#号，修改为：

```
network.host: [_local_, 172.30.6.1]
```

172.30.6.1为指定的ip地址，可以是多个。

这样就可以在浏览器里打开啦

[http://172.30.6.1](http://172.30.6.1/):9200/?pretty

## 可能遇到的问题

### 问题一

```
max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
```

**max_map_count** 的值是指一个进程最多可用于的内存映射区(memory map areas)，在调用malloc会用到，由mmap/mprotect生成。

解决办法:

切换到root用户修改配置/etc/sysctl.conf

```
su root
vim /etc/sysctl.conf
```

加入

```
vm.max_map_count=655360
```

然后使其生效

```
sysctl -p
```

### 问题二

```
[1]: max file descriptors [65535] for elasticsearch process is too low, increase to at least [65536]
```

文件描述符太低

解决办法:

切换到root用户修改/etc/security/limits.conf

```
su root
vim /etc/security/limits.conf
```

加入

```
* soft nofile 65536
* hard nofile 131072
* soft nproc 2048
* hard nproc 4096 
```

### 问题三

使用supervisor启动时，查看日志仍然报下面的错误

```
[1]: max file descriptors [65535] for elasticsearch process is too low, increase to at least [65536]
```

解决办法:

切换到root用户修改vim /etc/supervisord.d/elasticsearch.conf

```
[supervisord]
minfds=65536
minprocs=32768

[program:es]
process_name=%(program_name)s_%(process_num)02d
directory=/usr/local/elasticsearch-5.6.3/
command=/usr/local/elasticsearch-5.6.3/bin/elasticsearch
;autostart=true
autorestart=false
user=testuser
numprocs=1
```

## 4、集群搭建

### 1、插件安装

安装ElasticSearch-head插件，[下载地址](https://github.com/mobz/elasticsearch-head/archive/master.zip)

#### 安装node.js

EPEL（Extra Packages for Enterprise Linux）企业版Linux的额外软件包，是Fedora小组维护的一个软件仓库项目，为RHEL/CentOS提供他们默认不提供的软件包。
 先确认系统是否已经安装了`epel-release`包：

```
$ yum info epel-release
```

如果有输出有关`epel-release`的已安装信息，则说明已经安装，如果提示没有安装或可安装，则安装

```
$ sudo yum install epel-release
```

安装完后，就可以使用`yum`命令安装nodejs了，安装的一般会是较新的版本，并且会将`npm`作为依赖包一起安装

```
$ sudo yum install nodejs
```

安装完成后，验证是否正确的安装，`node -v`，如果输出如下版本信息，说明成功安装

```
v6.9.4
```

###  2、启动插件

下载后得到`master.zip`,解压

```shell
#下载github的项目
wget https://github.com/mobz/elasticsearch-head/archive/master.zip
#解压下载的目录
unzip master.zip
#解压后的目录
elasticsearch-head-master
cd elasticsearch-head-master
#安装依赖
npm install
#启动插件
npm run start
#启动成功
Started connect web server on http://localhost:9100

```

效果演示

 

 ![1.elastic-head](E:\ElasticSearchHouse\images\1.elastic-head.jpg)

### 3、创建主节点

修改ElasticSearch配置,使其成为主节点，并在9100端口进行检测

修改文件下的 `config/elasticsearch.yml`

```yaml
network.host: 192.168.179.131
#外部访问
http.cors.enabled: true
http.cors.allow-origin: "*"
#节点配置
cluster.name: lion
node.name: master
node.master: true
```

保存，启动主节点【非root用户启动】

```shell
[testuser@node1 elasticsearch-5.5.2]$ ./bin/elasticsearch -d
```

![2.elastic-master](E:\ElasticSearchHouse\images\2.elastic-master.jpg)

### 4、创建从节点

1、重新解压下载的ElasticSearch 

```shell
tar -zxvf elasticsearch-5.5.2.tar.gz -C /usr/local/es-slave1
tar -zxvf elasticsearch-5.5.2.tar.gz -C /usr/local/es-slave2
```

2、修改从机的配置文件

vim config/elasticsearch.yml

```shell
network.host: 192.168.179.131
#两个从机不相同
http.port: 8200

cluster.name: lion
node.name: slave1
discovery.zen.ping.unicast.hosts: ["192.168.179.131"]
```

启动从机【切换到非root启动】

![3.elastic-slave](E:\ElasticSearchHouse\images\3.elastic-slave.jpg)

# 3、项目环境搭建

## 1、新建一个SpringBoot项目

项目的结构如图所示

![4.newProject](E:\ElasticSearchHouse\images\4.newProject.jpg)

pom.xml文件如图所示

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.wdjr</groupId>
    <artifactId>xunwu-project</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <packaging>jar</packaging>

    <name>xunwu-project</name>
    <description>Demo project for Spring Boot</description>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>1.5.13.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <java.version>1.8</java.version>

        <!-- 使用自定义ES 版本 -->
        <elasticsearch.version>5.5.2</elasticsearch.version>

        <!-- thymeleaf 覆盖parent 选择自己的版本 -->
        <thymeleaf.version>3.0.3.RELEASE</thymeleaf.version>
        <thymeleaf-layout-dialect.version>2.1.1</thymeleaf-layout-dialect.version>
        <thymeleaf-extras-springsecurity4.version>3.0.2.RELEASE</thymeleaf-extras-springsecurity4.version>
    </properties>

    <dependencies>
        <!-- jpa相关依赖 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- 前端模板 thymeleaf 依赖 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>

        <!-- https://mvnrepository.com/artifact/org.thymeleaf/thymeleaf -->
        <dependency>
            <groupId>org.thymeleaf</groupId>
            <artifactId>thymeleaf</artifactId>
            <version>${thymeleaf.version}</version>
        </dependency>

        <dependency>
            <groupId>org.thymeleaf</groupId>
            <artifactId>thymeleaf-spring4</artifactId>
            <version>3.0.2.RELEASE</version>
        </dependency>

        <!-- SpringSecurity 依赖 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

        <!-- Thymeleaf方言支持SpringSecurity 依赖-->
        <dependency>
            <groupId>org.thymeleaf.extras</groupId>
            <artifactId>thymeleaf-extras-springsecurity4</artifactId>
            <version>${thymeleaf-extras-springsecurity4.version}</version>
        </dependency>

        <!-- redis session依赖 -->
        <dependency>
            <groupId>org.springframework.session</groupId>
            <artifactId>spring-session</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <!-- SpringBoot自带热加载开发工具 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- https://mvnrepository.com/artifact/joda-time/joda-time -->
        <dependency>
            <groupId>joda-time</groupId>
            <artifactId>joda-time</artifactId>
            <version>2.3</version>
        </dependency>

        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.5.0</version>
        </dependency>

        <!-- 七牛依赖 -->
        <dependency>
            <groupId>com.qiniu</groupId>
            <artifactId>qiniu-java-sdk</artifactId>
            <version>[7.2.0, 7.2.99]</version>
        </dependency>

        <!-- ModelMapper Simple, Intelligent, Object Mapping. -->
        <dependency>
            <groupId>org.modelmapper</groupId>
            <artifactId>modelmapper</artifactId>
            <version>1.1.0</version>
        </dependency>

        <dependency>
            <groupId>com.google.guava</groupId>
            <artifactId>guava</artifactId>
            <version>18.0</version>
        </dependency>

        <!-- ES -->
        <dependency>
            <groupId>org.elasticsearch.client</groupId>
            <artifactId>transport</artifactId>
            <version>${elasticsearch.version}</version>
        </dependency>

        <dependency>
            <groupId>org.apache.logging.log4j</groupId>
            <artifactId>log4j-core</artifactId>
            <version>2.7</version>
        </dependency>

        <!-- Kafka -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>

        <!-- mail -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-mail</artifactId>
        </dependency>

        <!-- 测试依赖 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>aliyun-java-sdk-core</artifactId>
            <version>3.2.3</version>
            <!--<scope>system</scope>-->
            <!--<systemPath>${project.basedir}/lib/aliyun-java-sdk-core-3.2.3.jar</systemPath>-->
        </dependency>
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>aliyun-java-sdk-dysmsapi</artifactId>
            <version>1.0.0</version>
            <!--<scope>system</scope>-->
            <!--<systemPath>${project.basedir}/lib/aliyun-java-sdk-dysmsapi-1.0.0.jar</systemPath>-->
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>


</project>
```



## 2、新建一个数据库

数据库的建表语句，如下所示

```sql
/*
 Navicat Premium Data Transfer

 Source Server         : xunwu
 Source Server Type    : MySQL
 Source Server Version : 50634
 Source Host           : 10.94.169.234
 Source Database       : xunwu

 Target Server Type    : MySQL
 Target Server Version : 50634
 File Encoding         : utf-8

 Date: 12/05/2017 23:07:26 PM
*/

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

DROP DATABASE IF EXISTS `xunwu`;
CREATE DATABASE `xunwu`;
USE `xunwu`;

-- ----------------------------
--  Table structure for `house`
-- ----------------------------
DROP TABLE IF EXISTS `house`;
CREATE TABLE `house` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'house唯一标识',
  `title` varchar(32) NOT NULL,
  `price` int(11) unsigned NOT NULL COMMENT '价格',
  `area` int(11) unsigned NOT NULL COMMENT '面积',
  `room` int(11) unsigned NOT NULL COMMENT '卧室数量',
  `floor` int(11) unsigned NOT NULL COMMENT '楼层',
  `total_floor` int(11) unsigned NOT NULL COMMENT '总楼层',
  `watch_times` int(11) unsigned DEFAULT '0' COMMENT '被看次数',
  `build_year` int(4) NOT NULL COMMENT '建立年限',
  `status` int(4) unsigned NOT NULL DEFAULT '0' COMMENT '房屋状态 0-未审核 1-审核通过 2-已出租 3-逻辑删除',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `last_update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最近数据更新时间',
  `city_en_name` varchar(32) NOT NULL COMMENT '城市标记缩写 如 北京bj',
  `region_en_name` varchar(255) NOT NULL COMMENT '地区英文简写 如昌平区 cpq',
  `cover` varchar(32) DEFAULT NULL COMMENT '封面',
  `direction` int(11) NOT NULL COMMENT '房屋朝向',
  `distance_to_subway` int(11) NOT NULL DEFAULT '-1' COMMENT '距地铁距离 默认-1 附近无地铁',
  `parlour` int(11) NOT NULL DEFAULT '0' COMMENT '客厅数量',
  `district` varchar(32) NOT NULL COMMENT '所在小区',
  `admin_id` int(11) NOT NULL COMMENT '所属管理员id',
  `bathroom` int(11) NOT NULL DEFAULT '0',
  `street` varchar(32) NOT NULL COMMENT '街道',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8mb4 COMMENT='房屋信息表';

-- ----------------------------
--  Records of `house`
-- ----------------------------
BEGIN;
INSERT INTO `house` VALUES ('15', '富力城 国贸CBD 时尚休闲 商务办公', '6200', '70', '2', '10', '20', '2', '2005', '1', '2017-09-06 18:56:14', '2017-12-03 11:13:46', 'bj', 'hdq', 'Fhxz_c16YmEmIz5UVxrp6ihwbvCk', '2', '10', '1', '融泽嘉园', '2', '0', '龙域西二路'), ('16', '富力城 国贸CBD 时尚休闲 商务办公', '6300', '70', '2', '10', '20', '0', '2012', '1', '2017-09-06 19:53:35', '2017-12-03 11:13:42', 'bj', 'hdq', 'FvkO1FFyGbrxCP_1O9tA94u2qvbP', '1', '-1', '1', '融泽嘉园', '2', '0', '龙域西二路'), ('17', '二环东直门地铁站附近、王府井、天安门、国贸、三里屯、南锣鼓巷', '3000', '35', '1', '5', '10', '2', '2013', '1', '2017-09-06 20:45:35', '2017-12-03 11:13:36', 'bj', 'hdq', 'FpVYJRsLykrBRyUSCEOeqsqWU-bt', '1', '200', '0', '融泽嘉园', '2', '0', '龙域西二路'), ('18', '华贸城 东向一居挑空loft 干净温馨 随时可以签约', '5700', '52', '1', '7', '20', '0', '2012', '1', '2017-09-06 21:01:02', '2017-12-03 11:13:30', 'bj', 'hdq', 'Fl1lNikhmMIecbTn-JTsurxugtFU', '2', '1085', '1', '融泽嘉园', '2', '0', '龙域西二路'), ('19', '望春园板楼三居室 自住精装 南北通透 采光好视野棒！', '9200', '132', '3', '6', '14', '0', '2005', '1', '2017-09-06 22:44:25', '2017-12-03 11:13:25', 'bj', 'hdq', 'Fp1xPKVYtPsCeVHVQVW0Hif2FXk7', '2', '1108', '2', '融泽嘉园', '2', '0', '龙域西二路'), ('20', '高大上的整租两居室 业主诚意出租', '5400', '56', '2', '12', '20', '0', '2012', '1', '2017-09-06 23:39:50', '2017-12-03 11:13:20', 'bj', 'hdq', 'FvVqU8LneZZ5xaLBAOM1KXR2Pz1X', '2', '-1', '1', '融泽嘉园', '2', '0', '龙域西二路'), ('21', '新康园 正规三居室 精装修 家电家具齐全', '1900', '18', '1', '13', '25', '0', '2012', '1', '2017-09-07 00:52:47', '2017-12-03 11:13:15', 'bj', 'hdq', 'FnuOFbFtDYTbpPdFoZthR-R0tszC', '3', '1302', '0', '融泽嘉园', '2', '0', '龙域西二路'), ('24', '湖光壹号望京华府183-387㎡阔景大宅', '50000', '288', '5', '1', '1', '0', '2015', '1', '2017-09-07 11:42:20', '2017-12-03 11:13:10', 'bj', 'hdq', 'FvVqU8LneZZ5xaLBAOM1KXR2Pz1X', '5', '200', '3', '融泽嘉园', '2', '0', '龙域西二路'), ('25', '测试房源-编辑', '3000', '59', '2', '10', '20', '0', '2010', '3', '2017-10-28 22:34:48', '2017-11-11 12:22:50', 'bj', 'cpq', 'FtbxR2LY98lnnX_TPOgOPzti3k7G', '2', '1000', '1', '融泽嘉园', '2', '0', '龙域中街');
COMMIT;

-- ----------------------------
--  Table structure for `house_detail`
-- ----------------------------
DROP TABLE IF EXISTS `house_detail`;
CREATE TABLE `house_detail` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `description` varchar(255) DEFAULT NULL COMMENT '详细描述',
  `layout_desc` varchar(255) DEFAULT NULL COMMENT '户型介绍',
  `traffic` varchar(255) DEFAULT NULL COMMENT '交通出行',
  `round_service` varchar(255) DEFAULT NULL COMMENT '周边配套',
  `rent_way` int(2) NOT NULL COMMENT '租赁方式',
  `address` varchar(32) NOT NULL COMMENT '详细地址 ',
  `subway_line_id` int(11) DEFAULT NULL COMMENT '附近地铁线id',
  `subway_line_name` varchar(32) DEFAULT NULL COMMENT '附近地铁线名称',
  `subway_station_id` int(11) DEFAULT NULL COMMENT '地铁站id',
  `subway_station_name` varchar(32) DEFAULT NULL COMMENT '地铁站名',
  `house_id` int(11) NOT NULL COMMENT '对应house的id',
  PRIMARY KEY (`id`),
  UNIQUE KEY `index_on_house_id` (`house_id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=33 DEFAULT CHARSET=utf8mb4;

-- ----------------------------
--  Records of `house_detail`
-- ----------------------------
BEGIN;
INSERT INTO `house_detail` VALUES ('21', '国贸CBD商务区,近SOHO现代城,富顿中心,富力城商业街区,乐成中心,潘家园古玩城,八王坟长途客运站,北京游乐园,经由三环路可直达首都机场。附近有双井桥南,双井桥北,双井桥东双井桥西等30多条公交站牌!\n《天安门,故宫,王府井,三里屯,前门,天坛,北海,颐和园,雍和宫,奥林匹克公园,水立方,西单,欢乐谷,燕莎商城等》知名购物区及旅游名胜古迹,是您休闲旅游及商务下榻的理想选择', '房间采光良好,落地窗外景色宜人', '房子处于北京的CBD商务中心区国贸双井!紧邻双井地铁站,步行5分钟即到!这离国贸、中央电视台、潘家园、三里屯、团结湖、日坛使馆区、儿研所、大郊亭都很近', '房子闹中取静,地理位置优越,交通方便,紧邻呼家楼地铁站和东大桥地铁站;去机场可乘坐东直门机场快轨,非常方便｡购物中心有双井购物中心、国贸购物中心和侨福芳草地购物中心、三里屯购物中心等,远道而来的朋友可尽览都市璀璨!', '0', '二号院7号楼', '4', '10号线', '58', '双井', '15'), ('22', '国贸CBD商务区,近SOHO现代城,富顿中心,富力城商业街区,乐成中心,潘家园古玩城,八王坟长途客运站,北京游乐园,经由三环路可直达首都机场。附近有双井桥南,双井桥北,双井桥东双井桥西等30多条公交站牌!\n《天安门,故宫,王府井,三里屯,前门,天坛,北海,颐和园,雍和宫,奥林匹克公园,水立方,西单,欢乐谷,燕莎商城等》知名购物区及旅游名胜古迹,是您休闲旅游及商务下榻的理想选择!', '房间采光良好,落地窗外景色宜人', '房子处于北京的CBD商务中心区国贸双井!紧邻双井地铁站,步行5分钟即到', '这离国贸、中央电视台、潘家园、三里屯、团结湖、日坛使馆区、儿研所、大郊亭都很近。房子闹中取静,地理位置优越,交通方便,紧邻呼家楼地铁站和东大桥地铁站;去机场可乘坐东直门机场快轨,非常方便｡购物中心有双井购物中心、国贸购物中心和侨福芳草地购物中心、三里屯购物中心等,远道而来的朋友可尽览都市璀璨！', '0', '1号院1号楼', '1', '13号线', '5', '上地', '16'), ('24', '我和我女盆友当房东已经一年了,也是超赞房东,希望能为大家提供舒适的住所~ 房间的大门和房门都是密码门,小区有保安24小时值班,非常安全方便。 通常入住时间是下午三点,提前来的同学可以先寄存行李和洗澡哦~\n\n', '房間非常漂亮,空間很大,鵝黃色的牆壁看起來非常舒服', '位置距離地鐵站不遠', '距故宫、天安门、王府井、三里屯、簋街、南锣鼓巷等景点均可地铁半小时内到达,交通便利~', '0', '1号院2号楼', '1', '13号线', '16', '东直门', '17'), ('25', '这个经纪人很懒，没写核心卖点', '此房是一居室的格局，上下两层，面宽，房间亮堂，进门右手厨房，正前方是25平米的客厅，楼上是卧室，带洗手间！ 喧闹和安静隔开，适合居住', '小区距离地铁13号线北苑站500米的距离，交通出行便利....', '小区楼下就是华贸天地娱乐街，保利电影院，眉州东坡，中信银行，麦当劳等娱乐休闲设施齐全', '0', '1号院3号楼', '1', '13号线', '11', '北苑', '18'), ('26', '这个经纪人很懒，没写核心卖点', '此房为望春园小区板楼南北通透户型，主卧客厅朝南，次卧朝北，两个客厅双卫，居住很舒适。', '距离地铁5号线立水桥南站630米，有464,465,966,081，621等多条公交线路，交通出行四通八达。', '小区旁有大型购物商场易事达，物美超市，丰宁蔬菜基地，航空总医院、安贞医院北苑分院，中国银行、中国农业银行、中国工商银行、中国交通银行、中国建设银行、招商银行分布。小区旁有天奥健身房，还有立水桥公园..', '0', '6号院1号楼', '1', '13号线', '10', '立水桥', '19'), ('27', '高大上的整租两居室 业主诚意出租\n1、客厅挑高、宽敞舒适、阳光充足 2、卧室搭配的很新颖，使用之高 3、厨房带阳台，让您和家人有足够的空间展现私家厨艺', '客厅挑高、宽敞舒适、阳光充足 2、卧室搭配的很新颖，使用之高 3、厨房带阳台，让您和家人有足够的空间展现私家厨艺', '近地铁13号线东直门站', '社区环境好，环境优美，适宜居住，人文素质高，物业管理完善； 2、属于低密度社区 ，适宜居住 3、小区的林密树多，让您感受花园一样的家', '0', '1号院5号楼', '1', '13号线', '16', '东直门', '20'), ('28', '房子是正规三室一厅一厨一卫，装修保持的不错，家电家具都齐全。\n', '房子客厅朝北面积比较大，主卧西南朝向，次卧朝北，另一个次卧朝西，两个次卧面积差不多大。', '小区出南门到8号线育新地铁站614米，交通便利，小区500米范围内有物美，三旗百汇，龙旗广场等几个比较大的商场，生活购物便利，出小区北门朝东952米是地铁霍营站，是8号线和 13号线的换乘站，同时还有个S2线，通往怀来。（数据来源百度地图）', '小区西边300米就是物美超市和三旗百汇市场（日常百货、粮油米面、瓜果蔬菜、生鲜海货等等，日常生活很便利，消费成本低），北边200米是龙旗购物广场和永辉超市（保利影院，KFC，麦当劳等，轻松满足娱乐消费）。小区里还有商店，饭店，家政等。', '0', '2号院1号楼', '1', '13号线', '9', '霍营', '21'), ('31', '懒死了 不谢', '户型介绍', '交通出行', '周边配套', '0', '3号院1号楼', '1', '13号线', '12', '望京西', '24'), ('32', '房屋描述-编辑', '户型介绍', '交通出行', '周边配套-编辑', '0', '3号院2单元1003', '1', '13号线', '8', '回龙观', '25');
COMMIT;

-- ----------------------------
--  Table structure for `house_picture`
-- ----------------------------
DROP TABLE IF EXISTS `house_picture`;
CREATE TABLE `house_picture` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `house_id` int(11) NOT NULL COMMENT '所属房屋id',
  `cdn_prefix` varchar(255) NOT NULL COMMENT '图片路径',
  `width` int(11) DEFAULT NULL COMMENT '宽',
  `height` int(11) DEFAULT NULL COMMENT '高',
  `location` varchar(32) DEFAULT NULL COMMENT '所属房屋位置',
  `path` varchar(255) NOT NULL COMMENT '文件名',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=86 DEFAULT CHARSET=utf8mb4 COMMENT='房屋图片信息';

-- ----------------------------
--  Records of `house_picture`
-- ----------------------------
BEGIN;
INSERT INTO `house_picture` VALUES ('68', '19', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '911', '683', null, 'Fp1xPKVYtPsCeVHVQVW0Hif2FXk7'), ('69', '19', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1012', '683', null, 'Fn371N5gLsJvjuIRC4IHjPtMy61h'), ('70', '24', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1280', '960', null, 'Fn1AGNmZfadCIVTJA33gByg6a33B'), ('71', '24', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FlgoAylUv1ilx1SAtxSyBCJF3bwb'), ('72', '21', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FnuOFbFtDYTbpPdFoZthR-R0tszC'), ('73', '21', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '455', '683', null, 'FhCiRnyCDQ-O6pXusu5ftmZkIh0-'), ('74', '20', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FvVqU8LneZZ5xaLBAOM1KXR2Pz1X'), ('75', '20', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FtNl9uPM6p5PjEs8z2FnOuViNtOM'), ('76', '18', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1440', '960', null, 'FgcD3BufAprERe5y3Gd-Mezu5VAy'), ('77', '18', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'Fl1lNikhmMIecbTn-JTsurxugtFU'), ('78', '17', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FvVHtS1qAApFFh6k5LMDm5tliufK'), ('79', '17', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FpVYJRsLykrBRyUSCEOeqsqWU-bt'), ('80', '16', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'Fhysh6EcQ_ZTl-jdGe2zaCFi5Uvm'), ('81', '16', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'Fvb9TDMRtl1haBj9gK9C0k43X0u0'), ('82', '16', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FvkO1FFyGbrxCP_1O9tA94u2qvbP'), ('83', '15', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FsxiS6rOTpSg5pK7tv41e8Zpnn_c'), ('84', '15', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1024', '683', null, 'FpOKJ2IEmbA1y1RbIqgZfqFKkJyS'), ('85', '15', 'http://7xo6gy.com1.z0.glb.clouddn.com/', '1440', '960', null, 'Fhxz_c16YmEmIz5UVxrp6ihwbvCk');
COMMIT;

-- ----------------------------
--  Table structure for `house_subscribe`
-- ----------------------------
DROP TABLE IF EXISTS `house_subscribe`;
CREATE TABLE `house_subscribe` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `house_id` int(11) NOT NULL COMMENT '房源id',
  `user_id` int(11) NOT NULL COMMENT '用户id',
  `desc` varchar(255) DEFAULT NULL COMMENT '用户描述',
  `status` int(2) NOT NULL DEFAULT '0' COMMENT '预约状态 1-加入待看清单 2-已预约看房时间 3-看房完成',
  `create_time` datetime NOT NULL COMMENT '数据创建时间',
  `last_update_time` datetime NOT NULL COMMENT '记录更新时间',
  `order_time` datetime DEFAULT NULL COMMENT '预约时间',
  `telephone` varchar(11) DEFAULT NULL COMMENT '联系电话',
  `admin_id` int(11) NOT NULL COMMENT '房源发布者id',
  PRIMARY KEY (`id`),
  UNIQUE KEY `index_on_user_and_house` (`house_id`,`user_id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8mb4 COMMENT='预约看房信息表';

-- ----------------------------
--  Records of `house_subscribe`
-- ----------------------------
BEGIN;
INSERT INTO `house_subscribe` VALUES ('9', '17', '1', null, '3', '2017-11-26 11:06:23', '2017-12-02 09:21:01', '2017-12-03 00:00:00', '13888888888', '2');
COMMIT;

-- ----------------------------
--  Table structure for `house_tag`
-- ----------------------------
DROP TABLE IF EXISTS `house_tag`;
CREATE TABLE `house_tag` (
  `house_id` int(11) NOT NULL COMMENT '房屋id',
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '标签id',
  `name` varchar(32) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `index_on_house_id_and_name` (`house_id`,`name`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8mb4 COMMENT='房屋标签映射关系表';

-- ----------------------------
--  Records of `house_tag`
-- ----------------------------
BEGIN;
INSERT INTO `house_tag` VALUES ('15', '18', '独立阳台'), ('15', '17', '空调'), ('16', '16', '光照充足'), ('17', '15', '随时看房'), ('17', '14', '集体供暖'), ('18', '13', '精装修'), ('19', '12', '独立卫生间'), ('19', '11', '独立阳台'), ('21', '19', '光照充足'), ('21', '20', '独立卫生间'), ('24', '10', '光照充足'), ('24', '3', '精装修'), ('24', '8', '集体供暖'), ('25', '21', '独立阳台');
COMMIT;

-- ----------------------------
--  Table structure for `role`
-- ----------------------------
DROP TABLE IF EXISTS `role`;
CREATE TABLE `role` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int(11) unsigned NOT NULL COMMENT '用户id',
  `name` varchar(32) NOT NULL COMMENT '用户角色名',
  PRIMARY KEY (`id`),
  UNIQUE KEY `user_id_and_name` (`user_id`,`name`) USING BTREE,
  KEY `user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8mb4 COMMENT='用户角色表';

-- ----------------------------
--  Records of `role`
-- ----------------------------
BEGIN;
INSERT INTO `role` VALUES ('1', '1', 'USER'), ('2', '2', 'ADMIN'), ('3', '3', 'USER'), ('4', '4', 'USER'), ('5', '5', 'USER'), ('6', '6', 'USER'), ('7', '7', 'USER'), ('8', '8', 'USER');
COMMIT;

-- ----------------------------
--  Table structure for `subway`
-- ----------------------------
DROP TABLE IF EXISTS `subway`;
CREATE TABLE `subway` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(32) NOT NULL COMMENT '线路名',
  `city_en_name` varchar(32) NOT NULL COMMENT '所属城市英文名缩写',
  PRIMARY KEY (`id`),
  KEY `index_on_city` (`city_en_name`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4;

-- ----------------------------
--  Records of `subway`
-- ----------------------------
BEGIN;
INSERT INTO `subway` VALUES ('1', '13号线', 'bj'), ('2', '1号线', 'bj'), ('3', '2号线', 'bj'), ('4', '10号线', 'bj'), ('5', '8号线', 'bj'), ('6', '9号线', 'bj'), ('7', '7号线', 'bj');
COMMIT;

-- ----------------------------
--  Table structure for `subway_station`
-- ----------------------------
DROP TABLE IF EXISTS `subway_station`;
CREATE TABLE `subway_station` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `subway_id` int(11) NOT NULL COMMENT '所属地铁线id',
  `name` varchar(32) NOT NULL COMMENT '站点名称',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_station` (`subway_id`,`name`)
) ENGINE=InnoDB AUTO_INCREMENT=65 DEFAULT CHARSET=utf8mb4;

-- ----------------------------
--  Records of `subway_station`
-- ----------------------------
BEGIN;
INSERT INTO `subway_station` VALUES ('5', '1', '上地'), ('16', '1', '东直门'), ('4', '1', '五道口'), ('14', '1', '光熙门'), ('11', '1', '北苑'), ('8', '1', '回龙观'), ('2', '1', '大钟寺'), ('12', '1', '望京西'), ('15', '1', '柳芳'), ('3', '1', '知春路'), ('10', '1', '立水桥'), ('13', '1', '芍药居'), ('6', '1', '西二旗'), ('1', '1', '西直门'), ('9', '1', '霍营'), ('7', '1', '龙泽'), ('33', '4', '三元家庄'), ('51', '4', '三元桥'), ('41', '4', '丰台站'), ('52', '4', '亮马桥'), ('27', '4', '健德门'), ('46', '4', '公主坟'), ('44', '4', '六里桥'), ('53', '4', '农业展览馆'), ('62', '4', '分钟寺'), ('59', '4', '劲松'), ('28', '4', '北土城'), ('61', '4', '十里河'), ('58', '4', '双井'), ('55', '4', '呼家楼'), ('54', '4', '团结湖'), ('57', '4', '国贸'), ('35', '4', '大红门'), ('32', '4', '太阳宫'), ('29', '4', '安贞门'), ('64', '4', '宋家庄'), ('20', '4', '巴沟'), ('30', '4', '惠新西街南口'), ('48', '4', '慈寿寺'), ('63', '4', '成寿寺'), ('42', '4', '泥洼'), ('22', '4', '海淀黄庄'), ('60', '4', '潘家园'), ('19', '4', '火器营'), ('26', '4', '牡丹园'), ('24', '4', '知春路'), ('23', '4', '知春里'), ('34', '4', '石榴庄'), ('39', '4', '纪家庙'), ('31', '4', '芍药居'), ('21', '4', '苏州街'), ('38', '4', '草桥'), ('45', '4', '莲花桥'), ('25', '4', '西土城'), ('43', '4', '西局'), ('47', '4', '西钓鱼台'), ('36', '4', '角门东'), ('37', '4', '角门西'), ('17', '4', '车道沟'), ('56', '4', '金台夕照'), ('18', '4', '长春桥'), ('40', '4', '首经贸');
COMMIT;

-- ----------------------------
--  Table structure for `support_address`
-- ----------------------------
DROP TABLE IF EXISTS `support_address`;
CREATE TABLE `support_address` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `belong_to` varchar(32) NOT NULL DEFAULT '0' COMMENT '上一级行政单位名',
  `en_name` varchar(32) NOT NULL COMMENT '行政单位英文名缩写',
  `cn_name` varchar(32) NOT NULL COMMENT '行政单位中文名',
  `level` varchar(16) NOT NULL COMMENT '行政级别 市-city 地区-region',
  `baidu_map_lng` double NOT NULL COMMENT '百度地图经度',
  `baidu_map_lat` double NOT NULL COMMENT '百度地图纬度',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_en_name_and_belong_to` (`en_name`,`level`,`belong_to`) USING BTREE COMMENT '每个城市的英文名都是独一无二的'
) ENGINE=InnoDB AUTO_INCREMENT=20 DEFAULT CHARSET=utf8mb4;

-- ----------------------------
--  Records of `support_address`
-- ----------------------------
BEGIN;
INSERT INTO `support_address` VALUES ('4', 'bj', 'bj', '北京', 'city', '116.395645', '39.929986'), ('5', 'sh', 'sh', '上海', 'city', '121.487899', '31.249162'), ('6', 'hb', 'sjz', '石家庄', 'city', '114.522082', '38.048958'), ('7', 'hb', 'ts', '唐山', 'city', '118.183451', '39.650531'), ('8', 'hb', 'hd', '邯郸', 'city', '114.482694', '36.609308'), ('9', 'bj', 'dcq', '东城区', 'region', '116.42188470126446', '39.93857401298612'), ('10', 'bj', 'xcq', '西城区', 'region', '116.37319010401802', '39.93428014370851'), ('12', 'bj', 'hdq', '海淀区', 'region', '116.23967780102151', '40.03316204507791'), ('13', 'bj', 'cpq', '昌平区', 'region', '116.21645635689414', '40.2217235498323'), ('14', 'sh', 'ptq', '普陀区', 'region', '121.39844294374956', '31.263742929075534'), ('15', 'sjz', 'caq', '长安区', 'region', '114.59262155387033', '38.07687479578663'), ('16', 'sjz', 'qdq', '桥东区', 'region', '114.51078430496142', '38.06338975380927'), ('17', 'sjz', 'qxq', '桥西区', 'region', '114.43813995531943', '38.033364550068136'), ('18', 'sjz', 'xhq', '新华区', 'region', '114.4535014286928', '38.117218640478164'), ('19', 'bj', 'cyq', '朝阳区', 'region', '116.52169489108084', '39.95895316640668');
COMMIT;

-- ----------------------------
--  Table structure for `user`
-- ----------------------------
DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '用户唯一id',
  `name` varchar(32) DEFAULT NULL COMMENT '用户名',
  `email` varchar(32) DEFAULT NULL COMMENT '电子邮箱',
  `phone_number` varchar(15) NOT NULL COMMENT '电话号码',
  `password` varchar(32) DEFAULT NULL COMMENT '密码',
  `status` int(2) unsigned NOT NULL DEFAULT '0' COMMENT '用户状态 0-正常 1-封禁',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '用户账号创建时间',
  `last_login_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上次登录时间',
  `last_update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '上次更新记录时间',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像',
  PRIMARY KEY (`id`),
  UNIQUE KEY `index_on_phone` (`phone_number`) USING BTREE COMMENT '用户手机号',
  UNIQUE KEY `index_on_username` (`name`) USING BTREE COMMENT '用户名索引',
  UNIQUE KEY `index_on_email` (`email`) USING BTREE COMMENT '电子邮箱索引'
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8mb4 COMMENT='用户基本信息表';

-- ----------------------------
--  Records of `user`
-- ----------------------------
BEGIN;
INSERT INTO `user` VALUES ('1', 'waliwali', 'wali@wali.com', '15111111111', '6fd1aad88b038aeecd9adeccc92b0bd1', '1', '2017-08-25 15:18:20', '2017-08-25 12:00:00', '2017-11-26 10:29:02', 'http://7xo6gy.com1.z0.glb.clouddn.com/99ff568bd61c744bf31185aeddf13580.png'), ('2', 'admin', 'admin@imooc.com', '1388888888', '55b3d0936a3fb63168d57a6bda0ddbbf', '1', '2017-08-27 09:07:05', '2017-08-27 09:07:07', '2017-10-21 15:03:57', 'http://7xo6gy.com1.z0.glb.clouddn.com/99ff568bd61c744bf31185aeddf13580.png'), ('5', '138****8888', null, '13888888888', null, '0', '2017-11-25 17:56:45', '2017-11-25 17:56:45', '2017-11-25 17:56:45', null), ('8', '151****9677', null, '15110059677', null, '0', '2017-11-25 18:58:18', '2017-11-25 18:58:18', '2017-11-25 18:58:18', null);
COMMIT;

SET FOREIGN_KEY_CHECKS = 1;


```

## 3、新建一个配置

在Resource目录下，新建一个SpringBoot的application.yml的文件，用来配置项目的相关功能

```yaml
#JapConfig
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://192.168.179.131:3306/xunwu?useSSL=false
    username: root
    password: Welcome_1
  jpa:
    show-sql: true
    hibernate:
    #只做验证，不做增删改的操作
      ddl-auto: validate
  #session会话存储类型
  session:
    store-type: hash_map

logging:
  level:
    org:
      hibernate:
        SQL: debug

#关闭http基本验证
security:
  basic:
    enabled: false
server:
  port: 9001
```

## 4、新建一个JPA配置类

```java
@Configuration
@EnableJpaRepositories(basePackages = "com.wdjr.repository")
@EnableTransactionManagement
public class JPAConfig {
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource")
    public DataSource dataSource(){
        return DataSourceBuilder.create().build();
    }

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(){
        HibernateJpaVendorAdapter jpaVendorAdapter = new HibernateJpaVendorAdapter();
        //是否生成sql
        jpaVendorAdapter.setGenerateDdl(false);
        LocalContainerEntityManagerFactoryBean entityManagerFactory = new LocalContainerEntityManagerFactoryBean();
        entityManagerFactory.setDataSource(dataSource());
        entityManagerFactory.setJpaVendorAdapter(jpaVendorAdapter);
        entityManagerFactory.setPackagesToScan("com.wdjr.entity");

        return entityManagerFactory;
    }

    /**
     * 实例化事务管理的类
     */
    @Bean
    public PlatformTransactionManager transactionManager(EntityManagerFactory entityManagerFactory){
        JpaTransactionManager tansactionManager = new JpaTransactionManager();
        tansactionManager.setEntityManagerFactory(entityManagerFactory);
        return tansactionManager;
    }

}
```

## 5、新建一个路由

在主程序中编写一个Controller,用于测试

```java
@RestController
public class HelloController {

    @GetMapping("/hello")
    public String hello(){
        return "Hello";
    }
}
```

 测试

# 4、单元测试

## 1、编写Entity类

```java
package com.wdjr.entity;



import javax.persistence.*;
import java.util.Date;

@Entity
@Table(name = "user")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    private String email;

    @Column(name="phone_number")
    private String phoneName;

    private Integer status;
    @Column(name="create_time")
    private Date createTime;

    @Column(name = "last_login_time")
    private Date lastLoginTime;

    @Column(name = "last_update_time")
    private Date lastUpadteTime;

    private String avatar;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPhoneName() {
        return phoneName;
    }

    public void setPhoneName(String phoneName) {
        this.phoneName = phoneName;
    }

    public Integer getStatus() {
        return status;
    }

    public void setStatus(Integer status) {
        this.status = status;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public Date getLastLoginTime() {
        return lastLoginTime;
    }

    public void setLastLoginTime(Date lastLoginTime) {
        this.lastLoginTime = lastLoginTime;
    }

    public Date getLastUpadteTime() {
        return lastUpadteTime;
    }

    public void setLastUpadteTime(Date lastUpadteTime) {
        this.lastUpadteTime = lastUpadteTime;
    }

    public String getAvatar() {
        return avatar;
    }

    public void setAvatar(String avatar) {
        this.avatar = avatar;
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", email='" + email + '\'' +
                ", phoneName='" + phoneName + '\'' +
                ", status=" + status +
                ", createTime=" + createTime +
                ", lastLoginTime=" + lastLoginTime +
                ", lastUpadteTime=" + lastUpadteTime +
                ", avatar='" + avatar + '\'' +
                '}';
    }
}
```

## 2、编写Repository类

主要通过继承JPA的CrudRepository类的功能，来实现User类的Crud【增删改查】

```java
public interface UserRepository extends CrudRepository<User,Long> {

}
```

## 3、编写测试类

```java
    @Autowired
    private UserRepository userRepository;

    @Test
    public void testFindOne(){
        User user = userRepository.findOne(1L);
        System.out.println(user);
    }
```

## 4、测试结果

```
2018-05-24 14:06:10.335 DEBUG 16316 --- [           main] org.hibernate.SQL                        : select user0_.id as id1_0_0_, user0_.avatar as avatar2_0_0_, user0_.create_time as create_t3_0_0_, user0_.email as email4_0_0_, user0_.last_login_time as last_log5_0_0_, user0_.last_update_time as last_upd6_0_0_, user0_.name as name7_0_0_, user0_.phone_number as phone_nu8_0_0_, user0_.status as status9_0_0_ from user user0_ where user0_.id=?
User{id=1, name='waliwali', email='wali@wali.com', phoneName='15111111111', status=1, createTime=2017-08-25 15:18:20.0, lastLoginTime=2017-08-25 12:00:00.0, lastUpadteTime=2017-11-26 10:29:02.0, avatar='http://7xo6gy.com1.z0.glb.clouddn.com/99ff568bd61c744bf31185aeddf13580.png'}

```

# 5、H2内存数据库

目的：在单独测试的时候，不想使用Mysql数据库，只是在内存中实现代码。

增加H2的相关配置文件

![5.h2config](E:\ElasticSearchHouse\images\5.h2config.jpg)

## 1、切换开发环境

编写application的yaml文件

```yaml
spring:
  profiles:
    active: test
  jpa:
    show-sql: true
    hibernate:
        #只做验证，不做增删改的操作
      ddl-auto: validate
  #session会话存储类型
  session:
    store-type: hash_map

logging:
  level:
    org:
      hibernate:
        SQL: debug

#关闭http基本验证
security:
  basic:
    enabled: false
server:
  port: 9001

---

#JapConfig
spring:
  profiles: dev
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://192.168.179.131:3306/xunwu?useSSL=false
    username: root
    password: Welcome_1

---
spring:
  profiles: test
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:test
    schema: classpath:db/schema.sql
    data: classpath:db/data.sql
```

## 2、H2的配置

### 1、H2的schame

```sql
DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
  `id` INT(11) NOT NULL IDENTITY PRIMARY KEY ,
  `name` VARCHAR(32) NOT NULL UNIQUE ,
  `password` VARCHAR(32) NOT NULL ,
  `email` VARCHAR(32) NOT NULL UNIQUE ,
  `phone_number` VARCHAR(15) NOT NULL UNIQUE ,
  `status` INT(2) NOT NULL ,
  `avatar` VARCHAR(255),
  `create_time` DATETIME NOT NULL DEFAULT NOW(),
  `last_login_time` DATETIME NOT NULL ,
  `last_update_time` DATETIME NOT NULL DEFAULT NOW()
);

DROP TABLE IF EXISTS `role`;
CREATE TABLE `role` (
  `id` INT(11) NOT NULL IDENTITY PRIMARY KEY ,
  `user_id` INT(11) NOT NULL,
  `name` VARCHAR(32) NOT NULL,
  UNIQUE (`user_id`, `name`)
);

CREATE INDEX ON `role`(`user_id`);

DROP TABLE IF EXISTS `support_address`;
CREATE TABLE `support_address` (
  `id` int(11) NOT NULL IDENTITY,
  `belong_to` VARCHAR(32) NOT NULL,
  `en_name` varchar(32) NOT NULL,
  `cn_name` varchar(32) NOT NULL,
  `level` varchar(16) NOT NULL,
  `baidu_map_lng` DOUBLE NOT NULL ,
  `baidu_map_lat` DOUBLE NOT NULL ,
  PRIMARY KEY (`id`)
);

CREATE INDEX ON `support_address` (`belong_to`,`en_name`,`level`);

DROP TABLE IF EXISTS `house`;
CREATE TABLE `house` (
  `id` int(11)  NOT NULL IDENTITY COMMENT 'house唯一标识',
  `title` varchar(32) NOT NULL,
  `price` int(11) NOT NULL COMMENT '价格',
  `area` int(11) NOT NULL COMMENT '面积',
  `room` int(11) NOT NULL COMMENT '卧室数量',
  `floor` int(11) NOT NULL COMMENT '楼层',
  `total_floor` int(11) NOT NULL COMMENT '总楼层',
  `watch_times` int(11) DEFAULT '0' COMMENT '被看次数',
  `build_year` int(4) NOT NULL COMMENT '建立年限',
  `status` int(4) NOT NULL DEFAULT '0' COMMENT '房屋状态 0-未审核 1-审核通过 2-已出租 3-逻辑删除',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `last_update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `city_en_name` varchar(32) NOT NULL COMMENT '城市标记缩写 如 北京bj',
  `region_en_name` varchar(32) NOT NULL COMMENT '区域标记缩写 如 朝阳区cyq',
  `cover` varchar(32) DEFAULT NULL COMMENT '封面',
  `direction` int(11) NOT NULL COMMENT '朝向',
  `distance_to_subway` int(11) NOT NULL DEFAULT '-1' COMMENT '距地铁距离 默认-1 附近无地铁',
  `parlour` int(11) NOT NULL DEFAULT '0' COMMENT '客厅数量',
  `district` varchar(32) NOT NULL COMMENT '所在小区',
  `admin_id` int(11) NOT NULL COMMENT '所属管理员id',
  `bathroom` int(11) NOT NULL DEFAULT '0' COMMENT '卫生间数量',
  `street` varchar(32) NOT NULL COMMENT '街道',
  PRIMARY KEY (`id`)
);

DROP TABLE IF EXISTS `house_detail`;
CREATE TABLE `house_detail` (
  `id` int(11) NOT NULL IDENTITY,
  `description` varchar(255) DEFAULT NULL COMMENT '详细描述',
  `layout_desc` varchar(255) DEFAULT NULL COMMENT '户型介绍',
  `traffic` varchar(255) DEFAULT NULL COMMENT '交通出行',
  `round_service` varchar(255) DEFAULT NULL COMMENT '周边配套',
  `rent_way` int(2) NOT NULL COMMENT '租赁方式',
  `address` varchar(32) NOT NULL COMMENT '详细地址 ',
  `subway_line_id` int(11) DEFAULT NULL COMMENT '附近地铁线id',
  `subway_line_name` varchar(32) DEFAULT NULL COMMENT '附近地铁线名称',
  `subway_station_id` int(11) DEFAULT NULL COMMENT '地铁站id',
  `subway_station_name` varchar(32) DEFAULT NULL COMMENT '地铁站名',
  `house_id` int(11) NOT NULL COMMENT '对应house的id',
  PRIMARY KEY (`id`)
);

DROP TABLE IF EXISTS `house_tag`;
CREATE TABLE `house_tag` (
  `house_id` int(11) NOT NULL COMMENT '房屋id',
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '标签id',
  `name` varchar(32) NOT NULL,
  PRIMARY KEY (`id`)
);
```

### 2、H2的data数据

```sql
INSERT INTO `user`(`id`, `name`, `email`, `phone_number`, `password`, `status`, `last_login_time`) VALUES (1, 'wali',
'wali@imooc.com', '13888888888', 'wali', 1, NOW());
INSERT INTO `user`(`id`, `name`, `email`, `phone_number`, `password`, `status`, `last_login_time`) VALUES (2, 'admin',
'admin@imooc.com', '13999999999', '55b3d0936a3fb63168d57a6bda0ddbbf', 1, NOW());

INSERT INTO `role`(`id`, `user_id`, `name`) VALUES (1, 1, 'USER');
INSERT INTO `role`(`id`, `user_id`, `name`) VALUES (2, 2, 'USER');
INSERT INTO `role`(`id`, `user_id`, `name`) VALUES (3, 3, 'ADMIN');

-- address data
INSERT INTO `support_address`(`id`, `belong_to`, `en_name`, `cn_name`, `level`, `baidu_map_lng`, `baidu_map_lat`)
  VALUES ('4', 'bj', 'bj', '北京', 'city', '116.395645','39.929986'),
      ('5', 'sh', 'sh', '上海', 'city', '121.487899', '31.249162'),
      ('6', 'hb', 'sjz', '石家庄', 'city', '114.522082', '38.048958'),
      ('7', 'hb', 'ts', '唐山', 'city', '118.183451', '39.650531'),
      ('8', 'hb', 'hd', '邯郸', 'city', '114.482694', '36.609308'),
      ('9', 'bj', 'dcq', '东城区', 'region', '116.42188470126446', '39.93857401298612'),
      ('10', 'bj', 'xcq', '西城区', 'region', '116.37319010401802', '39.93428014370851'),
      ('12', 'bj', 'hdq', '海淀区', 'region', '116.23967780102151', '40.03316204507791'),
      ('13', 'bj', 'cpq', '昌平区', 'region', '116.21645635689414', '40.2217235498323'),
      ('14', 'sh', 'ptq', '普陀区', 'region', '121.39844294374956', '31.263742929075534'),
      ('15', 'sjz', 'caq', '长安区', 'region', '114.59262155387033', '38.07687479578663'),
      ('16', 'sjz', 'qdq', '桥东区', 'region', '114.51078430496142', '38.06338975380927'),
      ('17', 'sjz', 'qxq', '桥西区', 'region', '114.43813995531943', '38.033364550068136'),
      ('18', 'sjz', 'xhq', '新华区', 'region', '114.4535014286928', '38.117218640478164'),
      ('19', 'bj', 'cyq', '朝阳区', 'region', '116.52169489108084', '39.95895316640668');

-- house data
INSERT INTO `house`(`id`, `title`, `price`, `area`, `room`, `floor`, `total_floor`, `watch_times`, `build_year`,
                    `status`, `create_time`, `last_update_time`, `city_en_name`, `region_en_name`, `cover`,
                    `direction`, `distance_to_subway`, `parlour`, `district`, `admin_id`, `bathroom`, `street`)
  VALUES ('15', '富力城 国贸CBD 时尚休闲 商务办公 超棒瓦力', '6200', '70', '2', '10', '20', '2', '2005', '1', '2017-09-06 18:56:14', '2017-09-15 00:26:59', 'bj', 'hdq', 'FmD3zKG-gUPOrNv0HwzZN7IbkAC_', '2', '10', '1', '融泽嘉园', '2', '0', '龙域西二路'),
  ('16', '富力城 国贸CBD 时尚休闲 商务办公', '6300', '70', '2', '10', '20', '0', '2012', '1', '2017-09-06 19:53:35', '2017-09-11 00:35:13', 'bj', 'hdq', 'FmD3zKG-gUPOrNv0HwzZN7IbkAC_', '1', '-1', '1', '融泽嘉园', '2', '0', '龙域西二路'),
  ('17', '二环东直门地铁站附近、王府井、天安门、国贸、三里屯、南锣鼓巷', '3000', '35', '1', '5', '10', '0', '2013', '1', '2017-09-06 20:45:35', '2017-09-11 00:35:05', 'bj', 'hdq', 'FhVdDhzVDH1dLVVx4jOaVXOCfnea', '1', '200', '0', '融泽嘉园', '2', '0', '龙域西二路'),
  ('18', '华贸城 东向一居挑空loft 干净温馨 随时可以签约', '5700', '52', '1', '7', '20', '0', '2012', '1', '2017-09-06 21:01:02', '2017-09-11 00:35:01', 'bj', 'hdq', 'FsxiS6rOTpSg5pK7tv41e8Zpnn_c', '2', '1085', '1', '融泽嘉园', '2', '0', '龙域西二路'),
  ('19', '望春园板楼三居室 自住精装 南北通透 采光好视野棒！', '9200', '132', '3', '6', '14', '0', '2005', '1', '2017-09-06 22:44:25', '2017-09-11 00:34:55', 'bj', 'hdq', 'Fl1lNikhmMIecbTn-JTsurxugtFU', '2', '1108', '2', '融泽嘉园', '2', '0', '龙域西二路'),
  ('20', '高大上的整租两居室 业主诚意出租', '5400', '56', '2', '12', '20', '0', '2012', '1', '2017-09-06 23:39:50', '2017-09-11 00:34:21', 'bj', 'hdq', 'FtNl9uPM6p5PjEs8z2FnOuViNtOM', '2', '-1', '1', '融泽嘉园', '2', '0', '龙域西二路'),
  ('21', '新康园 正规三居室 精装修 家电家具齐全', '1900', '18', '1', '13', '25', '0', '2012', '1', '2017-09-07 00:52:47', '2017-09-11 00:34:13', 'bj', 'hdq', 'Fn9sHC3Wx7qpYCmSxt-z8FZluf0Z', '3', '1302', '0', '融泽嘉园', '2', '0', '龙域西二路'),
  ('24', '湖光壹号望京华府183-387㎡阔景大宅', '50000', '288', '5', '1', '1', '0', '2015', '1', '2017-09-07 11:42:20', '2017-09-18 20:14:14', 'bj', 'hdq', 'FvVqU8LneZZ5xaLBAOM1KXR2Pz1X', '5', '200', '3', '融泽嘉园', '2', '0', '龙域西二路');

-- house_detail data
INSERT INTO `house_detail` VALUES ('21', '国贸CBD商务区,近SOHO现代城,富顿中心,富力城商业街区,乐成中心,潘家园古玩城,八王坟长途客运站,北京游乐园,经由三环路可直达首都机场。附近有双井桥南,双井桥北,双井桥东双井桥西等30多条公交站牌!\n《天安门,故宫,王府井,三里屯,前门,天坛,北海,颐和园,雍和宫,奥林匹克公园,水立方,西单,欢乐谷,燕莎商城等》知名购物区及旅游名胜古迹,是您休闲旅游及商务下榻的理想选择', '房间采光良好,落地窗外景色宜人', '房子处于北京的CBD商务中心区国贸双井!紧邻双井地铁站,步行5分钟即到!这离国贸、中央电视台、潘家园、三里屯、团结湖、日坛使馆区、儿研所、大郊亭都很近', '房子闹中取静,地理位置优越,交通方便,紧邻呼家楼地铁站和东大桥地铁站;去机场可乘坐东直门机场快轨,非常方便｡购物中心有双井购物中心、国贸购物中心和侨福芳草地购物中心、三里屯购物中心等,远道而来的朋友可尽览都市璀璨!', '0', '二号院7号楼', '4', '10号线', '58', '双井', '15'), ('22', '国贸CBD商务区,近SOHO现代城,富顿中心,富力城商业街区,乐成中心,潘家园古玩城,八王坟长途客运站,北京游乐园,经由三环路可直达首都机场。附近有双井桥南,双井桥北,双井桥东双井桥西等30多条公交站牌!\n《天安门,故宫,王府井,三里屯,前门,天坛,北海,颐和园,雍和宫,奥林匹克公园,水立方,西单,欢乐谷,燕莎商城等》知名购物区及旅游名胜古迹,是您休闲旅游及商务下榻的理想选择!', '房间采光良好,落地窗外景色宜人', '房子处于北京的CBD商务中心区国贸双井!紧邻双井地铁站,步行5分钟即到', '这离国贸、中央电视台、潘家园、三里屯、团结湖、日坛使馆区、儿研所、大郊亭都很近。房子闹中取静,地理位置优越,交通方便,紧邻呼家楼地铁站和东大桥地铁站;去机场可乘坐东直门机场快轨,非常方便｡购物中心有双井购物中心、国贸购物中心和侨福芳草地购物中心、三里屯购物中心等,远道而来的朋友可尽览都市璀璨！', '0', '1号院1号楼', null, null, null, null, '16'), ('24', '我和我女盆友当房东已经一年了,也是超赞房东,希望能为大家提供舒适的住所~ 房间的大门和房门都是密码门,小区有保安24小时值班,非常安全方便。 通常入住时间是下午三点,提前来的同学可以先寄存行李和洗澡哦~\n\n', '房間非常漂亮,空間很大,鵝黃色的牆壁看起來非常舒服', '位置距離地鐵站不遠', '距故宫、天安门、王府井、三里屯、簋街、南锣鼓巷等景点均可地铁半小时内到达,交通便利~', '0', '1号院2号楼', '1', '13号线', '16', '东直门', '17'), ('25', '这个经纪人很懒，没写核心卖点', '此房是一居室的格局，上下两层，面宽，房间亮堂，进门右手厨房，正前方是25平米的客厅，楼上是卧室，带洗手间！ 喧闹和安静隔开，适合居住', '小区距离地铁13号线北苑站500米的距离，交通出行便利....', '小区楼下就是华贸天地娱乐街，保利电影院，眉州东坡，中信银行，麦当劳等娱乐休闲设施齐全', '0', '1号院3号楼', '1', '13号线', '11', '北苑', '18'), ('26', '这个经纪人很懒，没写核心卖点', '此房为望春园小区板楼南北通透户型，主卧客厅朝南，次卧朝北，两个客厅双卫，居住很舒适。', '距离地铁5号线立水桥南站630米，有464,465,966,081，621等多条公交线路，交通出行四通八达。', '小区旁有大型购物商场易事达，物美超市，丰宁蔬菜基地，航空总医院、安贞医院北苑分院，中国银行、中国农业银行、中国工商银行、中国交通银行、中国建设银行、招商银行分布。小区旁有天奥健身房，还有立水桥公园..', '0', '6号院1号楼', '1', '13号线', '10', '立水桥', '19'), ('27', '高大上的整租两居室 业主诚意出租\n1、客厅挑高、宽敞舒适、阳光充足 2、卧室搭配的很新颖，使用之高 3、厨房带阳台，让您和家人有足够的空间展现私家厨艺', '客厅挑高、宽敞舒适、阳光充足 2、卧室搭配的很新颖，使用之高 3、厨房带阳台，让您和家人有足够的空间展现私家厨艺', '近地铁13号线东直门站', '社区环境好，环境优美，适宜居住，人文素质高，物业管理完善； 2、属于低密度社区 ，适宜居住 3、小区的林密树多，让您感受花园一样的家', '0', '1号院5号楼', '1', '13号线', '16', '东直门', '20'), ('28', '房子是正规三室一厅一厨一卫，装修保持的不错，家电家具都齐全。\n', '房子客厅朝北面积比较大，主卧西南朝向，次卧朝北，另一个次卧朝西，两个次卧面积差不多大。', '小区出南门到8号线育新地铁站614米，交通便利，小区500米范围内有物美，三旗百汇，龙旗广场等几个比较大的商场，生活购物便利，出小区北门朝东952米是地铁霍营站，是8号线和 13号线的换乘站，同时还有个S2线，通往怀来。（数据来源百度地图）', '小区西边300米就是物美超市和三旗百汇市场（日常百货、粮油米面、瓜果蔬菜、生鲜海货等等，日常生活很便利，消费成本低），北边200米是龙旗购物广场和永辉超市（保利影院，KFC，麦当劳等，轻松满足娱乐消费）。小区里还有商店，饭店，家政等。', '0', '2号院1号楼', '1', '13号线', '9', '霍营', '21'), ('31', '懒死了 不谢', '户型介绍', '交通出行', '周边配套', '0', '3号院1号楼', '1', '13号线', '12', '望京西', '24'), ('32', '房屋描述-编辑', '户型介绍', '交通出行', '周边配套-编辑', '0', '3号院2单元1003', '1', '13号线', '8', '回龙观', '25');

-- house tag data
INSERT INTO `house_tag` VALUES ('15', '18', '独立阳台'), ('15', '17', '空调'), ('16', '16', '光照充足'), ('17', '15', '随时看房'), ('17', '14', '集体供暖'), ('18', '13', '精装修'), ('19', '12', '独立卫生间'), ('19', '11', '独立阳台'), ('21', '19', '光照充足'), ('21', '20', '独立卫生间'), ('24', '10', '光照充足'), ('24', '3', '精装修'), ('24', '8', '集体供暖'), ('25', '21', '独立阳台');
```

## 3、测试类的编写

```java
@RunWith(SpringRunner.class)
@SpringBootTest
@Configuration
@ActiveProfiles("test")
public class ApplicationTests {

}
```

## 4、测试结果

```
2018-05-24 15:10:57.466 DEBUG 10612 --- [           main] org.hibernate.SQL                        : select user0_.id as id1_0_0_, user0_.avatar as avatar2_0_0_, user0_.create_time as create_t3_0_0_, user0_.email as email4_0_0_, user0_.last_login_time as last_log5_0_0_, user0_.last_update_time as last_upd6_0_0_, user0_.name as name7_0_0_, user0_.phone_number as phone_nu8_0_0_, user0_.status as status9_0_0_ from user user0_ where user0_.id=?
User{id=1, name='wali', email='wali@imooc.com', phoneName='13888888888', status=1, createTime=2018-05-24 15:10:47.657, lastLoginTime=2018-05-24 15:10:47.657, lastUpadteTime=2018-05-24 15:10:47.657, avatar='null'}
```

# 6、前端模板

使用Thymeleaf模板引擎+BootStrap

## 1、编写WebMvcConfig

```java
package com.wdjr.config;

import org.springframework.beans.BeansException;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;
import org.thymeleaf.spring4.SpringTemplateEngine;
import org.thymeleaf.spring4.templateresolver.SpringResourceTemplateResolver;
import org.thymeleaf.spring4.view.ThymeleafViewResolver;

@Configuration
public class WebMvcConfig extends WebMvcConfigurerAdapter implements ApplicationContextAware {

    private ApplicationContext applicationContext;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext=applicationContext;
    }
    /*
     * 模板资源解析器
     * */
    @Bean
    @ConfigurationProperties(prefix = "spring.thymeleaf")
    public SpringResourceTemplateResolver templateResolver(){
        SpringResourceTemplateResolver templateResolver = new SpringResourceTemplateResolver();
        templateResolver.setApplicationContext(this.applicationContext);

        return templateResolver;
    }
    /**
     * Thymeleaf标准方言解释器
     */
    @Bean
    public SpringTemplateEngine templateEngine(){
        SpringTemplateEngine templateEngine = new SpringTemplateEngine();
        templateEngine.setTemplateResolver(templateResolver());
        //支持Spring EL表达式
        templateEngine.setEnableSpringELCompiler(true);

        return templateEngine;
    }

    /**
     * 视图解析器
     */
    @Bean
    public ThymeleafViewResolver viewResolver(){
        ThymeleafViewResolver viewResolver = new ThymeleafViewResolver();
        viewResolver.setTemplateEngine(templateEngine());
        return viewResolver;
    }

}
```

## 2、编写配置文件

```yaml
#thymeleaf
thymeleaf:
  cache: false
  prefix: classpath:/templates/
  suffix: .html
```

## 3、编写Controller测试类

```java
@Controller
public class HomeController {

    @GetMapping("/")
    public String index(Model model){
        System.out.println("***************");
        model.addAttribute("name","你好");
        return "index";
    }
}
```

## 4、编写index.html

```html
<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
Hello
<span th:text="${name}"></span>
s你哈
</body>
</html>
```

## 5、效果演示

![6.webdemo](E:\ElasticSearchHouse\images\6.webdemo.jpg)



# 7、API结构设计

## 1、使用RestAPI

使用rest api风格定义访问规则

资源+浏览器方法，去确定执行的对应的功能

## 2、自定义API Response

1、新建一个base包，并在包下创建ApiResponse来定义输出规范

```java
package com.wdjr.base;

/**
 * API格式封装
 */
public class ApiResponse {

    private int code;
    private String message;
    private Object data;
    private boolean more;

    public ApiResponse(int code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = data;
    }
    public ApiResponse(){
        this.code=Status.SUCCESS.getCode();
        this.message=Status.SUCCESS.getStandardMessage();
    }

    public int getCode() {
        return code;
    }

    public void setCode(int code) {
        this.code = code;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    public Object getData() {
        return data;
    }

    public void setData(Object data) {
        this.data = data;
    }

    public boolean isMore() {
        return more;
    }

    public void setMore(boolean more) {
        this.more = more;
    }

    public static ApiResponse ofMessage(int code,String message){
        return new ApiResponse(code,message,null);
    }

    public static ApiResponse ofSuccess(Object data){
        return new ApiResponse(Status.SUCCESS.getCode(),Status.SUCCESS.getStandardMessage(),data);
    }

    public static ApiResponse ofStatus(Status status){
        return new ApiResponse(status.getCode(),status.getStandardMessage(),null);
    }
    //状态码和信息定义
    public enum  Status{
        SUCCESS(200,"OK"),
        BAD_REQUEST(400,"Bad Request"),
        INTERNAL_SERVER_ERROR(500,"Unkown Internal Error"),
        NOT_VALID_PARAM(40005,"Not valid Params"),
        NOT_SUPPORTED_OPERATION (40006,"Operation not supported"),
        NOT_LOGIN(50000,"Not Login");


        private int code;
        private String standardMessage;

        Status(int code, String standardMessage) {
            this.code = code;
            this.standardMessage = standardMessage;
        }

        public int getCode() {
            return code;
        }

        public void setCode(int code) {
            this.code = code;
        }

        public String getStandardMessage() {
            return standardMessage;
        }

        public void setStandardMessage(String standardMessage) {
            this.standardMessage = standardMessage;
        }
    }
}
```

2、编写Controller测试

```java
@GetMapping("/status")
@ResponseBody
public ApiResponse getStatus(){
    ApiResponse message = ApiResponse.ofMessage(200, "发送成功");
    return message;

}
```

3、演示效果

![7.jsonshow](E:\ElasticSearchHouse\images\7.jsonshow.jpg)

## 3、异常拦截器

为什么要使用异常拦截器？

- 页面拦截器
- API的异常拦截器

### 1、页面拦截

当页面访问错误的时候将页面进行拦截，防止出现系统自带的错误页面

编写一个ApiErrorController

```java
@Controller
public class AppErrorController implements ErrorController {
    private static final String ERROR_PATH="/error";

    private ErrorAttributes errorAttributes;
    @Override
    public String getErrorPath() {
        return ERROR_PATH;
    }
    @Autowired
    public AppErrorController(ErrorAttributes errorAttributes){
        this.errorAttributes = errorAttributes;
    }
    /**
     * web页面错误处理
     */
    @RequestMapping(value = "/error",produces = "text/html")
    public String errorPageHandler(HttpServletRequest request, HttpServletResponse response){
        int status = response.getStatus();
        switch (status){
            case 403:
                return "403";
            case 404:
                return "404";
            case 500:
                return "500";
        }
        return "index";
    }
    }
```

在templates文件夹下，新建一个 404.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
错误页面
</body>
</html>
```

效果演示

![8.errorpage](E:\ElasticSearchHouse\images\8.errorpage.jpg)

### 2、API拦截

继续编写ApiErrorController

```java
/*   *
    * 除了Web的外的错误处理，比如Json/XML等
    *
    * */
   private int getStatus(HttpServletRequest request){
       Integer status = (Integer) request.getAttribute("javax.servlet.error.status_code");
       if (status!=null){
           return status;
       }
       return 500;

   }

   @RequestMapping(value = "/error")
   @ResponseBody
   public ApiResponse errorApiHandler(HttpServletRequest request){
       RequestAttributes requestAttributes = new ServletRequestAttributes(request);
       Map<String,Object> attr = this.errorAttributes.getErrorAttributes(requestAttributes, false);

       int status = getStatus(request);

       return ApiResponse.ofMessage(status, String.valueOf(attr.getOrDefault("message", "error")));
   }
```

这是使用postman来演示客户端查看

![9.errorapi](E:\ElasticSearchHouse\images\9.errorapi.jpg)

# 二、业务开发

## 1、功能页面开发

1、404.html,403.html,500.html,logout.html

2、controller测试

```java
@GetMapping("/404")
public String notFoundPage(){
    return "404";
}

@GetMapping("/403")
public String accessError(){
    return "403";
}

@GetMapping("/500")
public String internalError(){
    return "500";
}

@GetMapping("/logout")
public String logoutPage(){
    return "logout";
}
```

## 2、后台管理模块

后台登录的目录结构

![11.loginprojectPage](E:\ElasticSearchHouse\images\11.loginprojectPage.jpg)

**实现目标**

- 后台登录
- 权限控制
- 注销功能

### 1、后台admin登录

首先做后台的登录模块，获取数据库用户--》通过用户获取角色--》将信息加载到内存--》根据角色确定权限--》根据权限对系统进行授权。

1、新建一个config/WebSecurityConfig,确定权限控制

```java
@EnableWebSecurity
@EnableGlobalMethodSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    /**
     * HTTP权限控制
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //资源访问权限
        http.authorizeRequests()
                .antMatchers("/admin/login").permitAll() //管理员登录入口
                .antMatchers("/static/**").permitAll()  //静态资源
                .antMatchers("/user/login").permitAll()  //用户登录入口
                .antMatchers("/admin/**").hasRole("ADMIN")
                .antMatchers("/user/**").hasAnyRole("ADMIN","USER")
                .antMatchers("/api/user/**").hasAnyRole("ADMIN","USER")
                .and()
                .formLogin()
                .loginProcessingUrl("/login") //配置角色登录处理入口
                .and();
        http.csrf().disable();
        //前端的iframe同源策略
        http.headers().frameOptions().sameOrigin();

        /**
         * 自定义认证策略
         */

    }
    @Autowired
    public void configGlobal(AuthenticationManagerBuilder auth) throws Exception {
//        auth.inMemoryAuthentication().withUser("admin").password("admin")
//                .roles("ADMIN").and();
        auth.authenticationProvider(authProvider()).eraseCredentials(true);
    }
    @Bean
    public AuthProvider authProvider(){
        return new AuthProvider();
    }
}
```

2、新建一个admin的登录页面，并且在controller中指定访问路径

```java
@GetMapping("/admin/login")
public String adminLoginPage(){
    return "admin/login";
}
```

3、新建一个角色Role的Entity实体类

```java
@Entity
@Table(name = "role")
public class Role {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name="user_id")
    private Long userId;

    private String name;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```

4、创建Repository，用于通过用户名获取用户，和通过用户的ID获取用户的role角色

role的获取

```java
public interface RoleRepository extends CrudRepository<Role,Long> {
    List<Role> findRoleByUserId(Long userId);
}
```

user的获取

```
public interface UserRepository extends CrudRepository<User,Long> {

    User findByName(String userName);
}
```

5、创建Service,根据获取的用户名获取的用户，将用户对应的角色，添加到权限校验中。

1）、UserService的接口

```java
public interface IUserService {
    User findUserName(String userName);
}
```

2）、UserService的实现

> ​     Authentication的getAuthorities()可以返回当前Authentication对象拥有的权限，即当前用户拥有的权限。其返回值是一个GrantedAuthority类型的数组，每一个GrantedAuthority对象代表赋予给当前用户的一种权限。GrantedAuthority是一个接口，其通常是通过UserDetailsService进行加载，然后赋予给UserDetails的。

> ​     GrantedAuthority中只定义了一个getAuthority()方法，该方法返回一个字符串，表示对应权限的字符串表示，如果对应权限不能用字符串表示，则应当返回null。

> ​      Spring Security针对GrantedAuthority有一个简单实现SimpleGrantedAuthority。该类只是简单的接收一个表示权限的字符串。Spring Security内部的所有AuthenticationProvider都是使用SimpleGrantedAuthority来封装Authentication对象。

```java
@Service
public class UserServiceImpl implements IUserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private RoleRepository roleRepository;

    @Override
    public User findUserName(String userName) {

        User user = userRepository.findByName(userName);
        if(user==null){
            return null;
        }
        List<Role> roles = roleRepository.findRoleByUserId(user.getId());

        if (roles == null || roles.isEmpty()){
            throw  new DisabledException("非法权限");
        }
        List<GrantedAuthority> authorities = new ArrayList<>();
        roles.forEach(role -> authorities.add(new SimpleGrantedAuthority("ROLE_"+ role.getName())));
        user.setAuthorityList(authorities);
        return user;
    }
}
```

6、实现自定义认证

```
从数据库中获取用户名密码，获取user加载到内存去认证
```

```java
public class AuthProvider implements AuthenticationProvider {

    @Autowired
    private IUserService userService;

    private final Md5PasswordEncoder passwordEncoder =new Md5PasswordEncoder();

    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        //获取用户名
        String userName = authentication.getName();
        //获取输入的密码
        String inputPassword = (String) authentication.getCredentials();
        User user = userService.findUserName(userName);
        if(user==null){
            throw  new AuthenticationCredentialsNotFoundException("authError");
        }

        if (this.passwordEncoder.isPasswordValid(user.getPassword(), inputPassword,user.getId() )){
            return new UsernamePasswordAuthenticationToken(user, null, user.getAuthorities());
        }
        throw new BadCredentialsException("authError");

    }

    @Override
    public boolean supports(Class<?> aClass) {
        return true;
    }
}
```

7、将AuthProvider加到WebSecurity的配置中

注：重复之前代码

```java
    @Autowired
    public void configGlobal(AuthenticationManagerBuilder auth) throws Exception {
//        auth.inMemoryAuthentication().withUser("admin").password("admin")
//                .roles("ADMIN").and();
        auth.authenticationProvider(authProvider()).eraseCredentials(true);
    }
```

### 2、登录跳转



解决问题：

1、登出，不是自己的logout页面

2、如果直接访问admin/center，会自动跳转到系统指定的login页面，需求跳转到admin/login

如果是user/center 就跳转到 /user/login

#### 1、注销页面跳转

1、修改logout页面的路由地址

```java
@GetMapping("/logout/page")
public String logoutPage(){
    return "logout";
}
```

2、在WebSecritryConfig中，将系统默认的logout换成自己的logout/page

```java
http.authorizeRequests()
        .antMatchers("/admin/login").permitAll() //管理员登录入口
        .antMatchers("/static/**").permitAll()  //静态资源
        .antMatchers("/user/login").permitAll()  //用户登录入口
        .antMatchers("/admin/**").hasRole("ADMIN")
        .antMatchers("/user/**").hasAnyRole("ADMIN","USER")
        .antMatchers("/api/user/**").hasAnyRole("ADMIN","USER")
        .and()
        .formLogin()
        .loginProcessingUrl("/login") //配置角色登录处理入口
        .and()
        .logout()
        .logoutUrl("/logout")
        .logoutSuccessUrl("/logout/page")
 ;
```

3、测试效果

![10.logout](E:\ElasticSearchHouse\images\10.logout.jpg)



#### 2、登录页面跳转

1）、新建一个LoginUrlEntryPoint

```java
package com.wdjr.security;

import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;
import org.springframework.util.AntPathMatcher;
import org.springframework.util.PathMatcher;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.HashMap;
import java.util.Map;

/**
 * 基于角色的登录入口控制器
 */

public class LoginUrlEntryPoint extends LoginUrlAuthenticationEntryPoint {

    private PathMatcher pathMatcher = new AntPathMatcher();

    private final Map<String,String> authEntryPointMap;

    public LoginUrlEntryPoint(String loginFormUrl) {
        super(loginFormUrl);
        authEntryPointMap = new HashMap<>();
        //普通用户登录入口
        authEntryPointMap.put("/user/**","/user/login" );
        //管理员登录入口
        authEntryPointMap.put("/admin/**", "/admin/login");
    }

    /**
     * 根据请求跳转到指定的页面，父类默认是使用loginFormUrl
     *
     * @param request
     * @param response
     * @param exception
     * @return
     */
    @Override
    protected String determineUrlToUseForThisRequest(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) {
        String uri = request.getRequestURI().replace(request.getContextPath(), "");
        for (Map.Entry<String, String> authEntry : this.authEntryPointMap.entrySet()) {
            if(this.pathMatcher.match(authEntry.getKey(), uri)){
                return authEntry.getValue();
            }
            
        }
        return super.determineUrlToUseForThisRequest(request, response, exception);
    }
}
```

2）、将配置加入WebSecritryConfig

```java
@Bean
public LoginUrlEntryPoint urlEntryPoint(){
    return new LoginUrlEntryPoint("/user/login");
}
@Override
protected void configure(HttpSecurity http) throws Exception {
//资源访问权限
http.authorizeRequests()
.antMatchers("/admin/login").permitAll() //管理员登录入口
.antMatchers("/static/**").permitAll()  //静态资源
.antMatchers("/user/login").permitAll()  //用户登录入口
.antMatchers("/admin/**").hasRole("ADMIN")
.antMatchers("/user/**").hasAnyRole("ADMIN","USER")
.antMatchers("/api/user/**").hasAnyRole("ADMIN","USER")
.and()
.formLogin()
.loginProcessingUrl("/login") //配置角色登录处理入口
.and()
.logout()
.logoutUrl("/logout")
.logoutSuccessUrl("/logout/page")
.deleteCookies("JSESSIONID")
.invalidateHttpSession(true)
.and()
.exceptionHandling()
.authenticationEntryPoint(urlEntryPoint())
.accessDeniedPage("/403");

http.csrf().disable();
//前端的iframe同源策略
http.headers().frameOptions().sameOrigin();

/**
* 自定义认证策略
*/

}
```

3）、测试

访问admin/center -->跳转到admin/login

访问user/center  -->跳转到user/login

#### 3、验证失败

如果登录失败返回例如：用户名密码错误

1、验证失败处理器

```java
public class LoginAuthFailHandler extends SimpleUrlAuthenticationFailureHandler {

    private final LoginUrlEntryPoint urlEntryPoint;

    public LoginAuthFailHandler(LoginUrlEntryPoint urlEntryPoint) {
        this.urlEntryPoint = urlEntryPoint;
    }

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
    //1.获取跳转的url
        String tagetUrl = this.urlEntryPoint.determineUrlToUseForThisRequest(request, response, exception);
        tagetUrl +="?"+exception.getMessage();
        super.setDefaultFailureUrl(tagetUrl);
        super.onAuthenticationFailure(request, response, exception);
    }
}
```

2、修改登录配置页面

```java
http.authorizeRequests()
        .antMatchers("/admin/login").permitAll() //管理员登录入口
        .antMatchers("/static/**").permitAll()  //静态资源
        .antMatchers("/user/login").permitAll()  //用户登录入口
        .antMatchers("/admin/**").hasRole("ADMIN")
        .antMatchers("/user/**").hasAnyRole("ADMIN","USER")
        .antMatchers("/api/user/**").hasAnyRole("ADMIN","USER")
        .and()
        .formLogin()
        .loginProcessingUrl("/login") //配置角色登录处理入口
        .failureHandler(authFailHandler())
        .and()
        .logout()
        .logoutUrl("/logout")
        .logoutSuccessUrl("/logout/page")
        .deleteCookies("JSESSIONID")
        .invalidateHttpSession(true)
        .and()
        .exceptionHandling()
        .authenticationEntryPoint(urlEntryPoint())
        .accessDeniedPage("/403");
```

中的

```java
.loginProcessingUrl("/login") //配置角色登录处理入口
.failureHandler(authFailHandler())
.and()


@Bean
public LoginAuthFailHandler authFailHandler(){
return new LoginAuthFailHandler(urlEntryPoint());
}
```

# 三、房源信息管理模块

实现目标：

- 新增房源
- 房源信息的管理（查、改、删）
- 房源审核

图片上传-本地-云，数据编辑审核

## 1、图片上传

### 1、本地图片上传

步骤：

新建一个本地存储的文件夹【/tmp】--> 新建路由【admin/upload/photo】-->新建一个文件上传配置【WebFileUploadConfig】-->配置Multipart属性【application.yml-dev】-->编写文件配置函数【WebFileUploadConfig】  -->  在controller中进行接收文件

1、新建路由

```java
@PostMapping(value = "admin/upload/photo",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
@ResponseBody
public ApiResponse uploadPhtot(@RequestParam("file")MultipartFile file){
    return ApiResponse.ofSuccess(null);
}
```

2、新建文件上传配置

```java
/**
 * 文件上传配置
 */

@Configuration
@ConditionalOnMissingBean({Servlet.class,StandardServletMultipartResolver.class,MultipartConfigElement.class})
@ConditionalOnProperty(prefix = "spring.http.multipart",name = "enabled",matchIfMissing = true)
@EnableConfigurationProperties(MultipartProperties.class)
public class WebFileUploadConfig {
    //springboot自动配置，接收
    private final MultipartProperties multipartProperties;

    public WebFileUploadConfig(MultipartProperties multipartProperties) {
        this.multipartProperties = multipartProperties;
    }
}
```

3、配置文件编写

```yaml
#multipart Config
http:
  multipart:
    enabled: true
    location: E:\ElasticSearchHouse\xunwu-project\tmp
    file-size-threshold: 5MB
    max-request-size: 20MB
```

4、继续修改文件上传配置

```java
@Configuration
@ConditionalOnMissingBean({Servlet.class,StandardServletMultipartResolver.class,MultipartConfigElement.class})
@ConditionalOnProperty(prefix = "spring.http.multipart",name = "enabled",matchIfMissing = true)
@EnableConfigurationProperties(MultipartProperties.class)
public class WebFileUploadConfig {
    //springboot自动配置，接收
    private final MultipartProperties multipartProperties;

    public WebFileUploadConfig(MultipartProperties multipartProperties) {
        this.multipartProperties = multipartProperties;
    }

    /**
     * 上传配置
     */
    @Bean
    @ConditionalOnMissingBean
    public MultipartConfigElement multipartConfigElement(){
        return this.multipartProperties.createMultipartConfig();
    }

    /**
     * 注册解析器
     */
    @Bean(name= DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)
    @ConditionalOnMissingBean(MultipartResolver.class)
    public StandardServletMultipartResolver multipartResolver(){
        StandardServletMultipartResolver multipartResolver = new StandardServletMultipartResolver();
        //设置懒加载，即点击上传，就会后台上传，不干涉其他程序
        multipartResolver.setResolveLazily(this.multipartProperties.isResolveLazily());
        return multipartResolver;
    }

}
```

5、在controller中接收文件

```java
@PostMapping(value = "admin/upload/photo",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
@ResponseBody
public ApiResponse uploadPhtot(@RequestParam("file")MultipartFile file){
    if(file.isEmpty()){
        return ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);
    }
    String filename = file.getOriginalFilename();
    File target = new File("E:\\ElasticSearchHouse\\xunwu-project\\tmp\\" + filename);
    try {
        //直接存在文件路径下
        file.transferTo(target);
    } catch (IOException e) {
        e.printStackTrace();
        return ApiResponse.ofStatus(ApiResponse.Status.INTERNAL_SERVER_ERROR);
    }
    return ApiResponse.ofSuccess(null);
}
```

6、上传演示

![12.uploadfile](E:\ElasticSearchHouse\images\12.uploadfile.jpg)

### 2、七牛上传图片

1、依赖导入

```xml
<!-- 七牛依赖 -->
<dependency>
    <groupId>com.qiniu</groupId>
    <artifactId>qiniu-java-sdk</artifactId>
    <version>[7.2.0, 7.2.99]</version>
</dependency>
```

[SDK文档查看](https://developer.qiniu.com/kodo/sdk/1239/java)

2、在配置文件中，指定七牛云对应的信息

![13.qiniu](E:\ElasticSearchHouse\images\13.qiniu.jpg)

```yaml
#qiniuyun
qiniu:
  AccessKey: BziT7hX9KcVglKX3dGCFbovaU9p2F4pMWLHlQAsp
  SecretKey: TTq0-4eezcI6dnaKZLmCemshzOJGHAtCxUw2bW0Q
  Bucket: test-xunwu
  cdn.prefix: p9h5uv2td.bkt.clouddn.com/
```

3、在WebUploadFile中继续添加七牛云相关配置

```java
/**
 * 华东机房
 */
@Bean
public com.qiniu.storage.Configuration qiniuConfig(){
    return new com.qiniu.storage.Configuration(Zone.zone0());
}

/**
 * 构建一个七牛上传实例
 */
@Bean
public UploadManager uploadManager(){
    return new UploadManager(qiniuConfig());
}
/**
 *     如何对接七牛云账户
 *     认证信息实例
 */
@Value("${qiniu.AccessKey}")
private String accessKey;

@Value("${qiniu.SecretKey}")
private String secretkey;

@Bean
public Auth auth(){
    return Auth.create(accessKey, secretkey);
}

/**
 * 构建七牛空间管理实例
 */
@Bean
public BucketManager bucketManager(){
    return new BucketManager(auth(), qiniuConfig());
}
```

4、编写七牛云的service接口

```java
/**
 * 七牛云服务
 */

public interface IQiNiuService {

    Response uploadFile(File file) throws QiniuException;

    Response uploadFile(InputStream inputStream) throws QiniuException;

    Response delete(String key) throws QiniuException;
}
```

#### 1、使用File格式上传

编写service接口的实现

```java
@Service
public class QiNiuServiceImpl implements IQiNiuService,InitializingBean {

    @Autowired
    private UploadManager uploadManager;

    @Autowired
    private BucketManager bucketManager;

    @Autowired
    private Auth auth;

    @Value("${qiniu.Bucket}")
    private String bucket;

    private StringMap putPolicy;

    /**
     * 文件参数上传
     * @param file
     * @return
     * @throws QiniuException
     */
    @Override
    public Response uploadFile(File file) throws QiniuException {
        Response response = this.uploadManager.put(file, null, getUploadToken());
        int retry = 0;
        if(response.needRetry() && retry< 3 ){
            this.uploadManager.put(file, null, getUploadToken());
            retry++;
        }
        return response;
    }

    @Override
    public Response uploadFile(InputStream inputStream) throws QiniuException {
        return null;
    }

    @Override
    public Response delete(String key) throws QiniuException {
        return null;
    }

    @Override
    public void afterPropertiesSet() throws Exception {
        this.putPolicy = new StringMap();
        putPolicy.put("returnBody", "{\"key\":\"$(key)\",\"hash\":\"$(etag)\",\"bucket\":\"$(bucket)\",\"width\":$(imageInfo.width),\"height\":${imageInfo.height}}" );

    }
    /**
     * 获取上传凭证
     */
    private String getUploadToken(){
        return this.auth.uploadToken(bucket, null, 3600, putPolicy);
    }
}
```

6、单例测试

```java
@Test
public void testUploadFile(){

    String filename = "E:\\ElasticSearchHouse\\xunwu-project\\tmp\\14.RabbitMQDirect.png";
    File file = new File(filename);

    Assert.assertTrue(file.exists());

    try {
        Response response = qiNiuService.uploadFile(file);
        Assert.assertTrue(response.isOK());
        System.out.println(response);
    } catch (QiniuException e) {
        e.printStackTrace();
    }
}
```

7、效果演示

![14.qiniuContent](E:\ElasticSearchHouse\images\14.qiniuContent.jpg)

#### 2、inputStream的上传【推荐】

1、在service实现中

```java
@Override
public Response uploadFile(InputStream inputStream) throws QiniuException {
    Response response = this.uploadManager.put(inputStream, null, getUploadToken(),null,null);
    int retry = 0;
    if(response.needRetry() && retry< 3 ){
        this.uploadManager.put(inputStream, null, getUploadToken(),null,null);
        retry++;
    }
    return response;
}
```

2、在WebUploadConfig中加入Gson

```java
@Bean
public Gson gson(){
    return new Gson();
}
```

编写Controller

```java
@Autowired
Gson gson;

@Autowired
IQiNiuService qiNiuService;
@PostMapping(value = "admin/upload/photo",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
@ResponseBody
public ApiResponse uploadPhtot(@RequestParam("file")MultipartFile file){
    if(file.isEmpty()){
        return ApiResponse.ofStatus(ApiResponse.Status.NOT_VALID_PARAM);
    }
    String filename = file.getOriginalFilename();

    try {
        InputStream inputStream = file.getInputStream();
        Response response = qiNiuService.uploadFile(inputStream);
        if(response.isOK()){
            QiNiuPutRet ret = gson.fromJson(response.bodyString(), QiNiuPutRet.class);
            return ApiResponse.ofSuccess(ret);
        }else{
            return ApiResponse.ofMessage(response.statusCode, response.getInfo());
        }


    }
    catch (QiniuException e){
        Response response = e.response;
        try {
            return ApiResponse.ofMessage(response.statusCode, response.bodyString());
        } catch (QiniuException e1) {
            return ApiResponse.ofStatus(ApiResponse.Status.INTERNAL_SERVER_ERROR);
        }

    }

    catch (IOException e) {
        e.printStackTrace();
        return ApiResponse.ofStatus(ApiResponse.Status.INTERNAL_SERVER_ERROR);
    }

}
```

演示

![15.qiniuContentinputStream](E:\ElasticSearchHouse\images\15.qiniuContentinputStream.jpg)

![16.qiniuimage](E:\ElasticSearchHouse\images\16.qiniuimage.jpg)

### 3、删除七牛图片

1、文件的service的实现类编写

```java
@Override
public Response delete(String key) throws QiniuException {
    Response response = bucketManager.delete(this.bucket, key);
    int retry=0;
    while (response.needRetry() && retry++<3){
        response = bucketManager.delete(bucket, key);
    }
    return response;
}
```

2、测试类编写

```java
@Test
public void testDeleteFile(){
    String key = "FgnPYoxZBdgiDu3ULFQdZRtTit45";
    try {
        qiNiuService.delete(key);
    } catch (QiniuException e) {
        e.printStackTrace();
    }
}
```

3、效果演示

![17.qiniuFile](E:\ElasticSearchHouse\images\17.qiniuFile.jpg)

删除后

![18.qiniuFile](E:\ElasticSearchHouse\images\18.qiniuFile.jpg)

## 2、新增房源信息

主要开发功能：就是数据回显，点击下拉列表有数据

**新的知识点**：

DTO ：数据对象传输类，用于隔离封装数据库do到dao的数据，保护数据；

ModelMap：BeanUtil的复制Bean功能的类，协助do转成dao；

ServiceMultiResult<T> :List<T>的升级,返回对应的结果集合和对象total，定义一个getSize方法；



目录数据结构

![19.addFunction](E:\ElasticSearchHouse\images\19.addFunction.jpg)

1、`ApiResponse`新增404 NOT FOUND,

> 结果集为null时报错；

```Java
public enum  Status{
    SUCCESS(200,"OK"),
    BAD_REQUEST(400,"Bad Request"),
    NOT_FOUND(404,"Not Found"),
    INTERNAL_SERVER_ERROR(500,"Unkown Internal Error"),
    NOT_VALID_PARAM(40005,"Not valid Params"),
    NOT_SUPPORTED_OPERATION (40006,"Operation not supported"),
    NOT_LOGIN(50000,"Not Login");
```

2、`WebMvcConfig`在容器中添加组件ModelMap

> BeanUtil复制类，可以将一个类复制成另一种格式

```java
@Bean
public ModelMapper modelMapper(){
    return new ModelMapper();
}
```


3、`SupportAddressDTO`新建一个Bean并且封装属性

> 数据传输层，用于将DO通过ModelMap的Bean复制功能成DTO，作为DAO的访问

```java
public class SupportAddressDTO {

    private Long id;
    @JsonProperty(value = "belong_to")
    private String belongTo;
    @JsonProperty(value = "en_name")
    private String enName;
    @JsonProperty(value = "cn_name")
    private String cnName;

    private String level;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getBelongTo() {
        return belongTo;
    }

    public void setBelongTo(String belongTo) {
        this.belongTo = belongTo;
    }

    public String getEnName() {
        return enName;
    }

    public void setEnName(String enName) {
        this.enName = enName;
    }

    public String getCnName() {
        return cnName;
    }

    public void setCnName(String cnName) {
        this.cnName = cnName;
    }

    public String getLevel() {
        return level;
    }

    public void setLevel(String level) {
        this.level = level;
    }
}
```

4、`SupportAddress`新建一个Bean

> DO用于 和数据库映射

```java
@Entity
@Table(name = "support_address")
public class SupportAddress {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;
    @Column(name = "belong_to")
    private String belongTo;
    @Column(name = "en_name")
    private String enName;
    @Column(name = "cn_name")
    private String cnName;

    private String level;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getBelongTo() {
        return belongTo;
    }

    public void setBelongTo(String belongTo) {
        this.belongTo = belongTo;
    }

    public String getEnName() {
        return enName;
    }

    public void setEnName(String enName) {
        this.enName = enName;
    }

    public String getCnName() {
        return cnName;
    }

    public void setCnName(String cnName) {
        this.cnName = cnName;
    }

    public String getLevel() {
        return level;
    }

    public void setLevel(String level) {
        this.level = level;
    }

    /**
     * 行政级别定义
     */
    public enum Level {
        CITY("city"),
        REGION("region");

        private String value;

        Level(String value) {
            this.value = value;
        }

        public String getValue(){
            return value;
        }
        private static Level of(String value){
            for (Level level : Level.values()) {
                if(level.value.equals(value)){
                    return level;
                }

            }
            throw new IllegalArgumentException();
        }
    }

}
```

5、`SupportAddressRepository`新建一个接口，继承`CrudRepository<SupportAddress,Long>`,写findAllByLevel方法

> 继承JPA的CRUD，可以通过Level获取所有数据库中的城市(s)信息

```java
public interface SupportAddressRepository extends CrudRepository<SupportAddress,Long> {
    /**
     * 获取所有的对应的行政级别的信息
     */

    List<SupportAddress> findAllByLevel(String level);
}
```

6、`ServiceMultiResult`新建一个泛型类，并且有total和result属性

> 对List的封装，可以获取结果集的数量和结果，用于后期分页等应用

```java
public class ServiceMultiResult<T> {
    private Integer total;
    private List<T> result;

    public ServiceMultiResult(Integer total, List<T> result) {
        this.total = total;
        this.result = result;
    }

    public Integer getTotal() {
        return total;
    }

    public void setTotal(Integer total) {
        this.total = total;
    }

    public List<T> getResult() {
        return result;
    }

    public void setResult(List<T> result) {
        this.result = result;
    }

    public int getResultSize(){
        if(this.result==null){
            return 0;
        }
        return this.result.size();
    }
}
```

7、`IAddressService`，新建一个接口，并新建一个findAllCities()方法

> 用于获取所有城市信息

```java
public interface IAddressService {

    public ServiceMultiResult<SupportAddressDTO> findAllCities();

}
```

8、`AddressServiceImpl`实现`IAddressService`接口类，并重写对应的方法

> 重点、获取JPA获取的城市内容DO，并通过modelMap转为DTO,返回ServiceMultiResult结果集

```java
@Service
public class AddressServiceImpl implements IAddressService {
    @Autowired
    private SupportAddressRepository supportAddressRepository;

    @Autowired
    private ModelMapper modelMapper;

    @Override
    public ServiceMultiResult<SupportAddressDTO> findAllCities() {
        //根据level获取所有地址
        List<SupportAddress> addresses = supportAddressRepository.findAllByLevel(SupportAddress.Level.CITY.getValue());
        //转换成DTO格式
        List<SupportAddressDTO> addressDTOS = new ArrayList<>();

        for (SupportAddress supportAddress : addresses) {
            SupportAddressDTO target = modelMapper.map(supportAddress, SupportAddressDTO.class);
            addressDTOS.add(target);
        }

        return new ServiceMultiResult<>(addressDTOS.size(), addressDTOS);
    }
}
```
9、`HouseController`新增方法getSupportCites的API方法

> 向后台指定链接传递城市相关的Api数据

```java
@Controller
public class HouseController {
    @Autowired
    private IAddressService addressService;

    @GetMapping("/address/support/cities")
    @ResponseBody
    public ApiResponse getSupportCities(){
        ServiceMultiResult<SupportAddressDTO> result = addressService.findAllCities();
        if(result.getResultSize()==0){
            return ApiResponse.ofSuccess(ApiResponse.Status.NOT_FOUND);
        }
        return ApiResponse.ofSuccess(result.getResult());
    }
}
```
10、结果演示

![20.cities](E:\ElasticSearchHouse\images\20.cities.jpg)

其他信息添加如上所示

其他信息:

城市对应的区域：region 

城市对应的地铁线 ：subway

地铁线对应的地铁站： subway_station

大致需要在程序中添加的是

- Bean类
- 对应的DTO
- Repository【JPA】
- service接口定义和实现
- HouseController方法

对应的文件

### 1、Bean类编写

![21.bean](E:\ElasticSearchHouse\images\21.bean.jpg)

`Subway`

```java
@Entity
@Table(name = "subway")
public class Subway {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @Column(name = "city_en_name")
    private String cityEnName;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getCityEnName() {
        return cityEnName;
    }

    public void setCityEnName(String cityEnName) {
        this.cityEnName = cityEnName;
    }
}
```

`SubwayStation`

```java
@Entity
@Table(name = "subway_station")
public class SubwayStation {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "subway_id")
    private Long subwayId;

    private String name;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getSubwayId() {
        return subwayId;
    }

    public void setSubwayId(Long subwayId) {
        this.subwayId = subwayId;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```

### 2、DTO编写

```java
public class SubwayDTO {

    private Long id;

    private String name;

    @JsonProperty(value = "city_en_name")
    private String cityEnName;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getCityEnName() {
        return cityEnName;
    }

    public void setCityEnName(String cityEnName) {
        this.cityEnName = cityEnName;
    }
}
```

`SubwayStation`

```java
public class SubwayStationDTO {

    private Long id;
    @JsonProperty(value = "subway_id")
    private Long subwayId;

    private String name;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getSubwayId() {
        return subwayId;
    }

    public void setSubwayId(Long subwayId) {
        this.subwayId = subwayId;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```

### 3、编写Repository

1）、城市对应区域【region】

```java
public interface SupportAddressRepository extends CrudRepository<SupportAddress,Long> {
    /**
     * 获取所有的对应的行政级别的信息
     */

    List<SupportAddress> findAllByLevel(String level);

    List<SupportAddress> findAllByLevelAndBelongTo(String enName,String belongTo);
}
```

2）、城市对应地铁线 【subway】

```java
public interface SubwayRepository extends CrudRepository<Subway,Long> {
    /**
     * 根据城市英文名称获取所有地铁
     * @param cityEnName
     * @return
     */
    List<Subway> findAllByCityEnName(String cityEnName);
}
```

3）、地铁线对应的地铁站【subwayStation】

```java
public interface SubwayStationRepository extends CrudRepository<SubwayStation,Long> {

    List<SubwayStation> findAllBySubwayId(Long subwayId);

}
```

### 4、接口定义和实现

接口定义

```java
/**
 * 地址服务接口
 */

public interface IAddressService {

    /**
     * 获取所有城市的支持列表
     * @return
     */
    ServiceMultiResult<SupportAddressDTO> findAllCities();

    /**
     * 根据英文名称简写获取具体区域信息 【北京】
     * @param cityEnName
     * @param regionEnName
     * @return
     */
    Map<SupportAddress.Level,SupportAddressDTO>findCityAndRegion(String cityEnName,String regionEnName);

    /**
     * 根据城市的英文简称，获取该城市的所有支持区域信息【大兴区】
     * @param cityName
     * @return
     */
    ServiceMultiResult<SupportAddressDTO>  findAllRegionsByCityName(String cityName);

    /**
     * 根据城市英文名称获取地铁线路信息【5号线】
     * @param cityEnName
     * @return
     */
    List<SubwayDTO> findAllSubwayByCityEnName(String cityEnName);

    /**
     * 根据地铁线路获取地铁的站信息【荣昌东街】
     * @param subwayId
     * @return
     */
    List<SubwayStationDTO> findAllStationBySubway(Long subwayId);

}
```

接口实现

```java
@Service
public class AddressServiceImpl implements IAddressService {
    @Autowired
    private SupportAddressRepository supportAddressRepository;

    @Autowired
    private SubwayRepository subwayRepository;

    @Autowired
    private SubwayStationRepository subwayStationRepository;

    @Autowired
    private ModelMapper modelMapper;

    @Override
    public ServiceMultiResult<SupportAddressDTO> findAllCities() {
        //根据level获取所有地址
        List<SupportAddress> addresses = supportAddressRepository.findAllByLevel(SupportAddress.Level.CITY.getValue());
        //转换成DTO格式
        List<SupportAddressDTO> addressDTOS = new ArrayList<>();

        for (SupportAddress supportAddress : addresses) {
            SupportAddressDTO target = modelMapper.map(supportAddress, SupportAddressDTO.class);
            addressDTOS.add(target);
        }

        return new ServiceMultiResult<>(addressDTOS.size(), addressDTOS);
    }

    @Override
    public Map<SupportAddress.Level, SupportAddressDTO> findCityAndRegion(String cityEnName, String regionEnName) {
        return null;
    }

    @Override
    public ServiceMultiResult<SupportAddressDTO> findAllRegionsByCityName(String cityName) {
        if (cityName==null){
            return new ServiceMultiResult<>(0, null);
        }
        List<SupportAddressDTO> result = new ArrayList<>();
        List<SupportAddress> regions = supportAddressRepository.findAllByLevelAndBelongTo(SupportAddress.Level.REGION.getValue(), cityName);
        for (SupportAddress region : regions) {
            result.add(modelMapper.map(region, SupportAddressDTO.class) );
        }
        return new ServiceMultiResult<>(regions.size(),result );
    }

    @Override
    public List<SubwayDTO> findAllSubwayByCityEnName(String cityEnName) {
        List<SubwayDTO> result = new ArrayList<>();
        List<Subway> subways = subwayRepository.findAllByCityEnName(cityEnName);
        if(subways.isEmpty()){
            return result;
        }
        subways.forEach(subway -> result.add(modelMapper.map(subway, SubwayDTO.class)));
        return result;
    }

    @Override
    public List<SubwayStationDTO> findAllStationBySubway(Long subwayId) {
        List<SubwayStationDTO> result = new ArrayList<>();
        List<SubwayStation> subwayStations = subwayStationRepository.findAllBySubwayId(subwayId);
        if(subwayStations.isEmpty()){
            return result;
        }
        subwayStations.forEach(subwayStation -> result.add(modelMapper.map(subwayStation, SubwayStationDTO.class) ));
        return result;
    }
}
```

### 5、Controller类的实现

```java
@Controller
public class HouseController {
    @Autowired
    private IAddressService addressService;

    /**
     * 获取支持城市列表
     * @return
     */
    @GetMapping("/address/support/cities")
    @ResponseBody
    public ApiResponse getSupportCities(){
        ServiceMultiResult<SupportAddressDTO> result = addressService.findAllCities();
        if(result.getResultSize()==0){
            return ApiResponse.ofSuccess(ApiResponse.Status.NOT_FOUND);
        }
        return ApiResponse.ofSuccess(result.getResult());
    }
    /**
     * 获取对应城市的支持区域列表
     */
    @GetMapping("/address/support/regions")
    @ResponseBody
    public ApiResponse getSupportRegions(@RequestParam(name = "city_name")String cityEnName){
        ServiceMultiResult<SupportAddressDTO> addressResult = addressService.findAllRegionsByCityName(cityEnName);
        if (addressResult.getResult() == null || addressResult.getTotal()<1){
            return ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);
        }
        return ApiResponse.ofSuccess(addressResult.getResult());
    }
    @GetMapping("/address/support/subway/line")
    @ResponseBody
    public ApiResponse getSubway(@RequestParam(name = "city_name")String cityEnName){
        List<SubwayDTO> subway = addressService.findAllSubwayByCityEnName(cityEnName);
        if (subway.isEmpty()){
            return ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);
        }
        return ApiResponse.ofSuccess(subway);
    }

    @GetMapping("/address/support/subway/station")
    @ResponseBody
    public ApiResponse getStation(@RequestParam(name = "subway_id")Long subwayId){
        List<SubwayStationDTO> subwayStations = addressService.findAllStationBySubway(subwayId);
        if(subwayStations.isEmpty()){
            return ApiResponse.ofStatus(ApiResponse.Status.NOT_FOUND);
        }
        return ApiResponse.ofSuccess(subwayStations);

    }

}
```

### 6、效果演示

![22.addFunction](E:\ElasticSearchHouse\images\22.addFunction.jpg)

## 3、新增房源实现

定义剩下的Bean、DTO、Repository，具体内容看git源码，都一个样

![23.other](E:\ElasticSearchHouse\images\23.other.jpg)



